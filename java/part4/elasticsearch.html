<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>glls</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="纸上得来终觉浅 觉知此事需躬行">
    
    <link rel="preload" href="/assets/css/0.styles.cdbb3724.css" as="style"><link rel="preload" href="/assets/js/app.cf24e5c2.js" as="script"><link rel="preload" href="/assets/js/3.96e6e8dc.js" as="script"><link rel="preload" href="/assets/js/1.9cd0fbb8.js" as="script"><link rel="preload" href="/assets/js/35.fc2b775b.js" as="script"><link rel="prefetch" href="/assets/js/10.e6679e1d.js"><link rel="prefetch" href="/assets/js/11.9031e886.js"><link rel="prefetch" href="/assets/js/12.7027c54a.js"><link rel="prefetch" href="/assets/js/13.000bd0c6.js"><link rel="prefetch" href="/assets/js/14.ed887876.js"><link rel="prefetch" href="/assets/js/15.a00f8181.js"><link rel="prefetch" href="/assets/js/16.6194edbb.js"><link rel="prefetch" href="/assets/js/17.35574e05.js"><link rel="prefetch" href="/assets/js/18.b4a0dc23.js"><link rel="prefetch" href="/assets/js/19.bbfbdcdb.js"><link rel="prefetch" href="/assets/js/20.f9712cb5.js"><link rel="prefetch" href="/assets/js/21.c5d37f51.js"><link rel="prefetch" href="/assets/js/22.8b74c1d6.js"><link rel="prefetch" href="/assets/js/23.afb7d1dd.js"><link rel="prefetch" href="/assets/js/24.93bb133f.js"><link rel="prefetch" href="/assets/js/25.174e73e9.js"><link rel="prefetch" href="/assets/js/26.1f08cfe8.js"><link rel="prefetch" href="/assets/js/27.f5387759.js"><link rel="prefetch" href="/assets/js/28.464ce114.js"><link rel="prefetch" href="/assets/js/29.62eca51f.js"><link rel="prefetch" href="/assets/js/30.eeb93e3b.js"><link rel="prefetch" href="/assets/js/31.119e5f3b.js"><link rel="prefetch" href="/assets/js/32.375b3a8c.js"><link rel="prefetch" href="/assets/js/33.2a684361.js"><link rel="prefetch" href="/assets/js/34.4bd3bd53.js"><link rel="prefetch" href="/assets/js/36.3cf77c8a.js"><link rel="prefetch" href="/assets/js/37.f2330e4e.js"><link rel="prefetch" href="/assets/js/38.537589f8.js"><link rel="prefetch" href="/assets/js/39.d6b70184.js"><link rel="prefetch" href="/assets/js/4.49793d4e.js"><link rel="prefetch" href="/assets/js/40.59f90851.js"><link rel="prefetch" href="/assets/js/41.a239b386.js"><link rel="prefetch" href="/assets/js/42.1e9cf7f1.js"><link rel="prefetch" href="/assets/js/43.917a5a3e.js"><link rel="prefetch" href="/assets/js/44.d31fbeb1.js"><link rel="prefetch" href="/assets/js/45.0b30863c.js"><link rel="prefetch" href="/assets/js/46.fa698e27.js"><link rel="prefetch" href="/assets/js/47.5cb4f5d8.js"><link rel="prefetch" href="/assets/js/48.8ddd1ecc.js"><link rel="prefetch" href="/assets/js/49.caf008b4.js"><link rel="prefetch" href="/assets/js/5.3e5c9da5.js"><link rel="prefetch" href="/assets/js/50.fde3c085.js"><link rel="prefetch" href="/assets/js/51.db458b1d.js"><link rel="prefetch" href="/assets/js/52.2cd02180.js"><link rel="prefetch" href="/assets/js/53.48a1e4d8.js"><link rel="prefetch" href="/assets/js/54.98d82cfd.js"><link rel="prefetch" href="/assets/js/6.e9258025.js"><link rel="prefetch" href="/assets/js/7.3130d9c3.js"><link rel="prefetch" href="/assets/js/8.eca9b250.js"><link rel="prefetch" href="/assets/js/9.e91cc53b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cdbb3724.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>glls</h3> <p class="description" data-v-59e6cb88>纸上得来终觉浅 觉知此事需躬行</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">glls</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="/java/" class="nav-link router-link-active"><i class="undefined"></i>
  java
</a></div><div class="nav-item"><a href="/front/" class="nav-link"><i class="undefined"></i>
  前端
</a></div><div class="nav-item"><a href="/pro/" class="nav-link"><i class="undefined"></i>
  项目案例
</a></div><div class="nav-item"><a href="/mianshi/" class="nav-link"><i class="undefined"></i>
  面试
</a></div><div class="nav-item"><a href="/qa/" class="nav-link"><i class="undefined"></i>
  QA
</a></div><div class="nav-item"><a href="/bishe/" class="nav-link"><i class="undefined"></i>
  毕设
</a></div><div class="nav-item"><a href="https://www.baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  百度
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      在线资料
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/mqyqingfeng" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/712139234359182/posts" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://i.heyige.cn/interview/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  东哥
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.yuque.com/laorenyuma/bh9tm1" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  瑞哥
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://codingsir.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  邢哥
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://modao.cc/community?source=nav&amp;page=1" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  原型图网站1
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.axureshop.com/a/b/axure-prototypes" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  原型图网站2
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>13</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="/java/" class="nav-link router-link-active"><i class="undefined"></i>
  java
</a></div><div class="nav-item"><a href="/front/" class="nav-link"><i class="undefined"></i>
  前端
</a></div><div class="nav-item"><a href="/pro/" class="nav-link"><i class="undefined"></i>
  项目案例
</a></div><div class="nav-item"><a href="/mianshi/" class="nav-link"><i class="undefined"></i>
  面试
</a></div><div class="nav-item"><a href="/qa/" class="nav-link"><i class="undefined"></i>
  QA
</a></div><div class="nav-item"><a href="/bishe/" class="nav-link"><i class="undefined"></i>
  毕设
</a></div><div class="nav-item"><a href="https://www.baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  百度
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      在线资料
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/mqyqingfeng" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/712139234359182/posts" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://i.heyige.cn/interview/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  东哥
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.yuque.com/laorenyuma/bh9tm1" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  瑞哥
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://codingsir.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  邢哥
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://modao.cc/community?source=nav&amp;page=1" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  原型图网站1
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.axureshop.com/a/b/axure-prototypes" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  原型图网站2
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/java/" class="sidebar-heading clickable router-link-active open"><span>欢迎学习</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/" aria-current="page" class="sidebar-link">学前必读</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/java/part1/test1" class="sidebar-heading clickable"><span>part1</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/java/part2/servlet.html" class="sidebar-heading clickable"><span>part2</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/java/part3/mybatis" class="sidebar-heading clickable"><span>part3</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group depth-0"><a href="/java/part4/1linux" class="sidebar-heading clickable"><span>part4</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/part4/1linux.html" class="sidebar-link">1linux</a></li><li><a href="/java/part4/2docker.html" class="sidebar-link">2docker</a></li><li><a href="/java/part4/3nginx.html" class="sidebar-link">3nginx</a></li><li><a href="/java/part4/4redis.html" class="sidebar-link">3redis</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88></h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title"></h1> <div data-v-8a445198><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/timg.jfif" alt="1587014280437"></p> <blockquote><p>Author：glls</p> <p>Version：9.0.1</p></blockquote> <p>[TOC]</p> <h3 id="一、引言"><a href="#一、引言" class="header-anchor">#</a> 一、引言</h3> <hr> <h4 id="_1-1-海量数据"><a href="#_1-1-海量数据" class="header-anchor">#</a> 1.1 海量数据</h4> <blockquote><p>在海量数据中执行搜索功能时，如果使用MySQL，效率太低。</p></blockquote> <p>TODO   mysql 索引相关的面试题？？？</p> <h4 id="_1-2-全文检索"><a href="#_1-2-全文检索" class="header-anchor">#</a> 1.2 全文检索</h4> <blockquote><p>在海量数据中执行搜索功能时，如果使用MySQL，效率太低。</p></blockquote> <h4 id="_1-3-高亮显示"><a href="#_1-3-高亮显示" class="header-anchor">#</a> 1.3 高亮显示</h4> <blockquote><p>将搜索关键字，以红色的字体展示。</p></blockquote> <h3 id="二、es概述"><a href="#二、es概述" class="header-anchor">#</a> 二、ES概述</h3> <hr> <h4 id="_2-1-es的介绍"><a href="#_2-1-es的介绍" class="header-anchor">#</a> 2.1 ES的介绍</h4> <blockquote><ul><li><p>ES是一个使用Java语言并且基于Lucene编写的搜索引擎框架，他提供了分布式的全文搜索功能，提供了一个统一的基于RESTful风格的WEB接口，官方客户端也对多种语言都提供了相应的API。</p></li> <li><p>Lucene：Lucene本身就是一个搜索引擎的底层。</p></li> <li><p>分布式：ES主要是为了突出他的横向扩展能力。</p></li> <li><p>全文检索：将一段词语进行分词，并且将分出的单个词语统一的放到一个分词库中，在搜索时，根据关键字去分词库中检索，找到匹配的内容。（倒排索引）</p></li> <li><p>RESTful风格的WEB接口：操作ES很简单，只需要发送一个HTTP请求，并且根据请求方式的不同，携带参数的同，执行相应的功能。</p></li> <li><p>应用广泛：Github.com，WIKI，Gold Man用ES每天维护将近10TB的数据。</p></li></ul></blockquote> <h4 id="_2-2-es的由来"><a href="#_2-2-es的由来" class="header-anchor">#</a> 2.2 ES的由来</h4> <table><thead><tr><th style="text-align:center;">ES回忆时光</th></tr></thead> <tbody><tr><td style="text-align:center;"><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/1587029047688.png" alt="1587029047688"></td></tr></tbody></table> <h4 id="_2-3-es和solr"><a href="#_2-3-es和solr" class="header-anchor">#</a> 2.3 ES和Solr</h4> <blockquote><ul><li>Solr在查询死数据时，速度相对ES更快一些。但是数据如果是实时改变的，Solr的查询速度会降低很多，ES的查询的效率基本没有变化。</li> <li>Solr搭建基于需要依赖Zookeeper来帮助管理。ES本身就支持集群的搭建，不需要第三方的介入。</li> <li>最开始Solr的社区可以说是非常火爆，针对国内的文档并不是很多。在ES出现之后，ES的社区火爆程度直线上升，ES的文档非常健全。</li> <li>ES对现在云计算和大数据支持的特别好。</li></ul></blockquote> <h4 id="_2-4-倒排索引"><a href="#_2-4-倒排索引" class="header-anchor">#</a> 2.4 倒排索引</h4> <blockquote><p>将存放的数据，以一定的方式进行分词，并且将分词的内容存放到一个单独的分词库中。</p> <p>当用户去查询数据时，会将用户的查询关键字进行分词。</p> <p>然后去分词库中匹配内容，最终得到数据的id标识。</p> <p>根据id标识去存放数据的位置拉取到指定的数据。</p> <p><strong>检索的时候  先将检索的内容分词   然后 去分词库匹配  拿到匹配数据的索引 再根据索引去数据存储的位置 拿到匹配的数据</strong></p></blockquote> <p>elk     elasticsearch (存储分析检索数据)   +   logstash （采集数据）   +   kibana （展示数据的图形化界面）</p> <table><thead><tr><th style="text-align:center;">倒排索引</th></tr></thead> <tbody><tr><td style="text-align:center;"><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/1587278510541.png" alt="1587278510541"></td></tr></tbody></table> <h4 id="_2-5基本概念"><a href="#_2-5基本概念" class="header-anchor">#</a> 2.5基本概念</h4> <h5 id="_2-4-1-index-索引"><a href="#_2-4-1-index-索引" class="header-anchor">#</a> 2.4.1 Index (索引)</h5> <p>动词 ，相当于Mysql 中的insert</p> <p>名词， 相当于Mysql 中的 Database</p> <h5 id="_2-4-2-type-类型"><a href="#_2-4-2-type-类型" class="header-anchor">#</a> 2.4.2 Type （类型）</h5> <p>在Index(索引)中 ，可以定义一个或多个类型。</p> <p>类似Mysql 中的table ,每一种类型的数据放在一起</p> <h5 id="_2-4-3-document-文档"><a href="#_2-4-3-document-文档" class="header-anchor">#</a> 2.4.3 Document （文档）</h5> <p>保存在某个索引（index）下，某种类型（type）的一个数据（Document） ,文档是json 格式的，Document 就像是Mysql 中某个table里面的内容。</p> <img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20200913180053166.png" alt="image-20200913180053166" style="zoom:80%;"> <h3 id="三、-elasticsearch安装"><a href="#三、-elasticsearch安装" class="header-anchor">#</a> 三、 ElasticSearch安装</h3> <hr> <h4 id="_3-1-安装es-kibana-不建议"><a href="#_3-1-安装es-kibana-不建议" class="header-anchor">#</a> 3.1 安装ES&amp;Kibana      不建议</h4> <div class="language-yml extra-class"><pre class="language-yml"><code>1.下载镜像文件
docker pull elasticsearch<span class="token punctuation">:</span>7.4.2
docker pull kibana<span class="token punctuation">:</span>7.4.2
2.创建挂载目录
mkdir <span class="token punctuation">-</span>p /mydata/elasticsearch/config
mkdir <span class="token punctuation">-</span>p /mydata/elasticsearch/data
<span class="token key atrule">echo &quot;http.host</span><span class="token punctuation">:</span> 0.0.0.0&quot;  <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span>  /mydata/elasticsearch/config/elasticsearch.yml 
3.启动容器
docker run <span class="token punctuation">-</span><span class="token punctuation">-</span>name elasticsearch <span class="token punctuation">-</span>p 9200<span class="token punctuation">:</span>9200 <span class="token punctuation">-</span>p 9300<span class="token punctuation">:</span>9300 \
<span class="token punctuation">-</span>e &quot;discovery.type=single<span class="token punctuation">-</span>node&quot; \
<span class="token punctuation">-</span>e ES_JAVA_OPTS=&quot;<span class="token punctuation">-</span>Xms512m <span class="token punctuation">-</span>Xmx1024m&quot; \
<span class="token punctuation">-</span>v /mydata/elasticsearch/config/elasticsearch.yml<span class="token punctuation">:</span>/usr/share/elasticsearch/config/elasticsearch.yml \
<span class="token punctuation">-</span>v /mydata/elasticsearch/data<span class="token punctuation">:</span>/usr/share/elasticsearch/data \
<span class="token punctuation">-</span>v /mydata/elasticsearch/plugins<span class="token punctuation">:</span>/usr/share/elasticsearch/plugins \
<span class="token punctuation">-</span>d elasticsearch<span class="token punctuation">:</span>7.4.2

<span class="token comment">#如果 启动elasticsearch  失败,  查看  日期  docker logs 容器id   查看  某容器的日志</span>
<span class="token comment">#docker logs 容器id</span>
<span class="token comment"># 需要 给 elasticsearch 目录授权</span>
<span class="token comment">#chmod -R 777 /mydata/elasticsearch/     给整个目录授权   可读可写可执行</span>
<span class="token comment">#在启动容器 应该就好了</span>

4.启动kibana
docker run <span class="token punctuation">-</span><span class="token punctuation">-</span>name kibana <span class="token punctuation">-</span>e ELASTICSEARCH_URL=http<span class="token punctuation">:</span>//192.168.5.202<span class="token punctuation">:</span>9200 <span class="token punctuation">-</span>p 5601<span class="token punctuation">:</span>5601\
 <span class="token punctuation">-</span>d kibana<span class="token punctuation">:</span>7.4.2

测试访问
http<span class="token punctuation">:</span>//192.168.5.202<span class="token punctuation">:</span>9200     如访问不到  查看日志
http<span class="token punctuation">:</span>//192.168.5.202<span class="token punctuation">:</span>5601     如访问不到  查看日志  看容器内  kibana.yml 中 ip 地址是否正确

</code></pre></div><h5 id="_3-1-1-使用docker-compose的方式安装-推荐"><a href="#_3-1-1-使用docker-compose的方式安装-推荐" class="header-anchor">#</a> 3.1.1   使用docker-compose的方式安装(推荐)</h5> <blockquote><p>mkdir -p /mydata/elasticsearch/config
mkdir -p /mydata/elasticsearch/data</p> <p>echo &quot;http.host: 0.0.0.0&quot;  &gt;&gt;  /mydata/elasticsearch/config/elasticsearch.yml</p></blockquote> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.1&quot;</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
 <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> daocloud.io/library/elasticsearch<span class="token punctuation">:</span>7.4.2
  <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
  <span class="token key atrule">container_name</span><span class="token punctuation">:</span> elasticsearch
  <span class="token key atrule">environment</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> /opt/docker_elasticsearch/config/elasticsearch.yml<span class="token punctuation">:</span>/usr/share/elasticsearch/config/elasticsearch.yml
     <span class="token punctuation">-</span> /opt/docker_elasticsearch/data<span class="token punctuation">:</span>/usr/share/elasticsearch/data
     <span class="token punctuation">-</span> /opt/docker_elasticsearch/plugins<span class="token punctuation">:</span>/usr/share/elasticsearch/plugins
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> 9200<span class="token punctuation">:</span><span class="token number">9200</span>
     <span class="token punctuation">-</span> 9300<span class="token punctuation">:</span><span class="token number">9300</span>
 <span class="token key atrule">kibana</span><span class="token punctuation">:</span>
   <span class="token key atrule">image</span><span class="token punctuation">:</span> daocloud.io/library/kibana<span class="token punctuation">:</span>7.4.2
   <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
   <span class="token key atrule">container_name</span><span class="token punctuation">:</span> kibana
   <span class="token key atrule">ports</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> 5601<span class="token punctuation">:</span><span class="token number">5601</span>
   <span class="token key atrule">environment</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> elasticsearch_url=http<span class="token punctuation">:</span>//192.168.133.103<span class="token punctuation">:</span><span class="token number">9200</span>
   <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> elasticsearch

</code></pre></div><p>9300 端口 为 es 集群间组件的通信端口，9200 端口为浏览器访问的http 协议resetful 端口</p> <p>记得 给文件夹授权    授权之后 再docker-compose up</p> <p>chmod 777 config</p> <p>chmod 777 data</p> <p>如果 访问 http://192.168.199.109:9200  失败  查看日志  是否vm内存配置过小  elasticsearch启动时遇到的错误</p> <p>问题翻译过来就是：elasticsearch用户拥有的内存权限太小，至少需要262144；解决办法1：</p> <p>在  /etc/sysctl.conf文件最后添加一行</p> <p>vm.max_map_count=262144     把宿主机内存配大一些</p> <p>解决办法2 启动时 指定内存    咱们的安装方法 就是启动时 指定内存</p> <h4 id="_3-2-安装ik分词器"><a href="#_3-2-安装ik分词器" class="header-anchor">#</a> 3.2 安装IK分词器</h4> <blockquote><p>ik 分词器 就是 elasticsearch 的一个插件</p></blockquote> <blockquote><ul><li>下载IK分词器的地址：https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.4.2/elasticsearch-analysis-ik-7.4.2.zip</li> <li>进去到ES容器内部，跳转到bin目录下，执行bin目录下的脚本文件：</li> <li>./elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.4.2/elasticsearch-analysis-ik-7.4.2.zip</li> <li>重启ES的容器，让IK分词器生效。</li></ul> <p>注意： 如果 在线安装太慢的话   可以先下载下来 压缩包  然后手动安装</p> <p>把下载的压缩 包   解压到  挂载目录  plugins 下的  ik 文件夹里,</p> <p>cd /mydata/elasticsearch/plugins</p> <p>mkdir ik</p> <p>cd ik     先把压缩包 放在  ik 目录中</p> <p>unzip  elasticsearch-analysis-ik-7.4.2.zip      解压完之后  可以把 压缩包删掉  rm -rf  *.zip</p> <p>进入容器内部  bin 目录下     执行      elasticsearch-plugin list     查看   插件列表  有没有   ik</p> <p>ik_max_word 是ik 分词器 的  一种分词方式   还有别的分词方式 后面遇到再说</p></blockquote> <table><thead><tr><th>校验IK分词器</th></tr></thead> <tbody><tr><td><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/1587042602899.png" alt="1587042602899"></td></tr></tbody></table> <h3 id="四、-elasticsearch基本操作"><a href="#四、-elasticsearch基本操作" class="header-anchor">#</a> 四、 ElasticSearch基本操作</h3> <hr> <h4 id="_4-1-es的结构-操作es-之前-先了解es-的结构"><a href="#_4-1-es的结构-操作es-之前-先了解es-的结构" class="header-anchor">#</a> 4.1 ES的结构   --- 操作es 之前 先了解es 的结构</h4> <h5 id="_4-1-1-索引index-分片和备份"><a href="#_4-1-1-索引index-分片和备份" class="header-anchor">#</a> 4.1.1 索引Index，分片和备份</h5> <blockquote><ul><li><p>ES的服务中，可以创建多个索引。</p></li> <li><p>每一个索引默认被分成5片存储。</p></li> <li><p>每一个分片都会存在至少一个备份分片。</p></li> <li><p>备份分片默认不会帮助检索数据，当ES检索压力特别大的时候，备份分片才会帮助检索数据。</p></li> <li><p>备份的分片必须放在不同的服务器中。</p> <p>理解： 索引index是es 中最大的数据存储单位 ，和mysql 的区别是  一个索引（index）中可以存海量（几亿条）数据  ，如果我们要在几亿条数据中检索出几条想要的数据 效率会很低  所以 es 提供了 一种对索引进行分片的机制 ，ES 天然支持集群，在集群服务器中 ES 把一个索引进行分片 放在不同的服务器上 如下图  例如 有一亿条数据 分成两个分片 每个分片上有5000万条数据  这样做的好处 一是 提高查询速度 二是 提高数据的存储量，另外 为了保证数据的安全  每个主分片会有备份分片   主分片和备份分片在不同的服务器上 ，  比如 主分片2 挂掉了  在 ES服务1 上面 还有 主分片2的备份分片 ，这样在一定程度上保证了数据的安全性 避免数据的丢失。但是 如果 当前集群中 只有一台es服务器   那么 这台服务器上 放的都是主分片，没有备份分片，什么时候扩展了集群中的 另一台服务器 才会存放备份分片。</p></li></ul></blockquote> <table><thead><tr><th style="text-align:center;">索引分片备份</th></tr></thead> <tbody><tr><td style="text-align:center;"><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/1587048753470.png" alt="1587048753470"></td></tr></tbody></table> <h5 id="_4-1-2-类型-type"><a href="#_4-1-2-类型-type" class="header-anchor">#</a> 4.1.2 类型 Type</h5> <blockquote><p>一个索引下，可以创建多个类型。</p> <p><a href="">Ps：根据版本不同，类型的创建也不同。</a></p> <p>es7 版本 不推荐使用type ，但是还是能用，到后面的es 版本 就不能再使用type 了</p></blockquote> <table><thead><tr><th style="text-align:center;">类型</th></tr></thead> <tbody><tr><td style="text-align:center;"><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/1587048924494.png" alt="1587048924494"></td></tr></tbody></table> <h5 id="_4-1-3-文档-doc"><a href="#_4-1-3-文档-doc" class="header-anchor">#</a> 4.1.3 文档 Doc</h5> <blockquote><p>一个类型下，可以有多个文档。这个文档就类似于MySQL表中的多行数据。</p></blockquote> <table><thead><tr><th style="text-align:center;">文档</th></tr></thead> <tbody><tr><td style="text-align:center;"><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/1587048972631.png" alt="1587048972631"></td></tr></tbody></table> <h5 id="_4-1-4-属性-field"><a href="#_4-1-4-属性-field" class="header-anchor">#</a> 4.1.4 属性 Field</h5> <blockquote><p>一个文档中，可以包含多个属性。类似于MySQL表中的一行数据存在多个列。</p></blockquote> <table><thead><tr><th style="text-align:center;">属性</th></tr></thead> <tbody><tr><td style="text-align:center;"><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/1587049031609.png" alt="1587049031609"></td></tr></tbody></table> <h4 id="_4-2-操作es的restful语法"><a href="#_4-2-操作es的restful语法" class="header-anchor">#</a> 4.2 操作ES的RESTful语法</h4> <blockquote><ul><li><p>GET请求：</p> <ul><li><p><code>http://ip:port/_cat/nodes</code>：查看所有节点    在kibana 中使用    GET _cat/nodes</p></li> <li><p><code>http://ip:port/_cat/health</code>：查看es 健康状况</p></li> <li><p><code>http://ip:port/_cat/master</code>：查看主节点</p></li> <li><p><code>http://ip:port/_cat/indices</code>：查看所有索引       相当于   show databases;</p></li> <li><p><code>http://ip:port/index</code>：查询索引信息           GET book   相当于查看 数据库表结构</p></li> <li><p><code>http://ip:port/index/type/doc_id</code>：查询指定的文档信息</p> <p>注意 咱们用的是 es 7  直接使用type 的  话 会给出警告信息  ，咱们使用  _doc  代替 type</p> <p>比如  查询指定文档信息   GET   book/_doc/1    查询 book 索引中 id 为1 的文档信息</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET book/_doc/2
</code></pre></div></li></ul></li> <li><p>POST请求：</p> <ul><li><p><code>http://ip:port/index/type/doc_id</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 指定文档id的添加操作             如果索引还未创建 还可以创建索引</span>
POST book/_doc/2
<span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;西游记&quot;</span>,   
  <span class="token string">&quot;author&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;吴承恩&quot;</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>http://ip:port/index/type/_search</code>：查询文档，可以在请求体中添加json字符串来代表查询条件</p> <div class="language- extra-class"><pre><code># 查询操作
POST book/_search
{
  &quot;query&quot;:{
    &quot;match&quot;: {
      &quot;name&quot;: &quot;西游记&quot;
    }
  }
}
</code></pre></div><ul><li><p><code>http://ip:port/index/type/doc_id/_update</code>：修改文档，在请求体中指定json字符串代表修改的具体信息     注意  带 _update 的  修改  json 格式 里需要加 doc  对比 本文档下面的案例说明</p> <p>POST book/_update/1      # 修改操作
{
&quot;doc&quot;:{
&quot;name&quot;:&quot;大奉打更2人&quot;,<br>
&quot;author&quot;:&quot;xxxxx2&quot;
}
}</p></li> <li><p>PUT请求：</p></li> <li><p><code>http://ip:port/index</code>：创建一个索引，也可以在请求体中指定索引的信息，类型，结构</p></li></ul> <p>PUT book2    # 创建一个叫 book2 的索引   执行第二次会报错</p> <div class="language- extra-class"><pre><code>              # 添加或修改文档    第一次是添加（同样 索引不存在 也会创建索引） 后面再执行是修改
</code></pre></div><p>PUT book3/_doc/1
{
&quot;name&quot;:&quot;java&quot;
}</p> <div class="language- extra-class"><pre><code>    - `http://ip:port/index/type/_mappings`：代表创建索引时，指定索引文档存储的属性的信息
</code></pre></div><ul><li><p>DELETE请求：
- <code>http://ip:port/index</code>：删除索引</p> <p>DELETE book2     # 删除book2 索引</p></li> <li><p><code>http://ip:port/index/type/doc_id</code>：删除指定的文档</p> <p>DELETE book/_doc/2      删除索引book中  id 为2 的文档</p></li></ul></li></ul></li></ul></blockquote> <p>​</p> <h4 id="_4-3-索引的操作"><a href="#_4-3-索引的操作" class="header-anchor">#</a> 4.3 索引的操作</h4> <h5 id="_4-3-1-创建一个索引"><a href="#_4-3-1-创建一个索引" class="header-anchor">#</a> 4.3.1 创建一个索引</h5> <blockquote><p>语法如下    先创建一个最简单的 先不指定他的结构化数据</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 创建一个索引
PUT /person
<span class="token punctuation">{</span>
  <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;number_of_shards&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>      # 分片 数<span class="token number">5</span>   
    <span class="token property">&quot;number_of_replicas&quot;</span><span class="token operator">:</span> <span class="token number">1</span>    # 备份
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_4-3-2-查看索引信息"><a href="#_4-3-2-查看索引信息" class="header-anchor">#</a> 4.3.2 查看索引信息</h5> <blockquote><p>语法如下     去management  中 查看索引信息</p> <p>Primaries  意思是 分片</p> <p>Replicas     意思是备份</p> <p>Health        健康状态黄色    表示不太健康   因为现在es 集群中只有一台服务器  备份分片没有地方存放 所以是黄色的健康状态， 如果 集群中有多台服务器  备份分片 就可以存储在别的服务器上  避免这台服务器挂掉  数据丢失问题</p> <p>点索引的名字 可以查看索引的详细信息</p></blockquote> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 查看索引信息</span>
GET /person
</code></pre></div><p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201206130416212.png" alt="image-20201206130416212"></p> <table><thead><tr><th style="text-align:center;">查看信息</th></tr></thead> <tbody><tr><td style="text-align:center;"><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/1587090545722.png" alt="1587090545722"></td></tr></tbody></table> <h5 id="_4-3-3-删除索引"><a href="#_4-3-3-删除索引" class="header-anchor">#</a> 4.3.3 删除索引</h5> <blockquote><p>语法如下</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 删除索引
DELETE /person
</code></pre></div><h4 id="_4-4-es中field可以指定的类型"><a href="#_4-4-es中field可以指定的类型" class="header-anchor">#</a> 4.4 ES中Field可以指定的类型</h4> <blockquote><ul><li><p>字符串类型：</p> <ul><li>text：一把被用于全文检索。 将当前Field进行分词。</li> <li>keyword：当前Field不会被分词。</li></ul></li> <li><p>数值类型：</p> <ul><li>long：取值范围为-9223372036854774808~922337203685477480(-2的63次方到2的63次方-1)，占用8个字节</li> <li>integer：取值范围为-2147483648~2147483647(-2的31次方到2的31次方-1)，占用4个字节</li> <li>short：取值范围为-32768~32767(-2的15次方到2的15次方-1)，占用2个字节</li> <li>byte：取值范围为-128~127(-2的7次方到2的7次方-1)，占用1个字节</li> <li>double：1.797693e+308~ 4.9000000e-324 (e+308表示是乘以10的308次方，e-324表示乘以10的负324次方)占用8个字节</li> <li>float：3.402823e+38 ~ 1.401298e-45(e+38表示是乘以10的38次方，e-45表示乘以10的负45次方)，占用4个字节</li> <li>half_float：精度比float小一半。</li> <li>scaled_float：根据一个long和scaled来表达一个浮点型，long-345，scaled-100 -&gt; 3.45</li></ul></li> <li><p>时间类型：</p> <ul><li>date类型，针对时间类型指定具体的格式</li></ul></li> <li><p>布尔类型：</p> <ul><li>boolean类型，表达true和false</li></ul></li> <li><p>二进制类型：</p> <ul><li>binary类型暂时支持Base64 encode string</li></ul></li> <li><p>范围类型：</p> <ul><li>long_range：赋值时，无需指定具体的内容，只需要存储一个范围即可，指定gt，lt，gte，lte</li> <li>integer_range：同上</li> <li>double_range：同上</li> <li>float_range：同上</li> <li>date_range：同上</li> <li>ip_range：同上</li></ul></li> <li><p>经纬度类型：</p> <ul><li>geo_point：用来存储经纬度的</li></ul></li> <li><p>ip类型：</p> <ul><li>ip：可以存储IPV4或者IPV6</li></ul></li></ul> <p><a href="">其他的数据类型参考官网：</a>https://www.elastic.co/guide/en/elasticsearch/reference/7.6/mapping-types.html</p></blockquote> <h4 id="_4-5-创建索引并指定数据结构"><a href="#_4-5-创建索引并指定数据结构" class="header-anchor">#</a> 4.5 创建索引并指定数据结构</h4> <blockquote><p>语法如下</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 创建索引，指定数据结构
PUT /book
<span class="token punctuation">{</span>
  <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    # 分片数
    <span class="token property">&quot;number_of_shards&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    # 备份数
    <span class="token property">&quot;number_of_replicas&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  # 指定数据结构
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    # 类型 Type       es <span class="token number">7</span>  可以把这个删了
    <span class="token property">&quot;novel&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      # 文档存储的Field
      <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        # Field属性名
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    		# 类型
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
    		# 指定分词器 # 在对这个属性做分词的时候 使用 ik分词器
          <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
    		# 指定当前Field可以被作为查询的条件 如果为<span class="token boolean">false</span> 则不能作为查询条件
          <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">,</span>
    		# 当前field是否需要额外存储    一般设置为<span class="token boolean">false</span> 即可  不需要额外存储
          <span class="token property">&quot;store&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span> 
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            # keyword 也算是字符串类型 
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;count&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;on-sale&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;date&quot;</span><span class="token punctuation">,</span>
           # 时间类型的格式化方式 
          <span class="token property">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;descr&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
            # 在对这个属性做分词的时候 使用 ik分词器
          <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-6-文档的操作"><a href="#_4-6-文档的操作" class="header-anchor">#</a> 4.6 文档的操作</h4> <blockquote><p>文档在ES服务中的唯一标识，<code>_index</code>，<code>_type</code>，<code>_id</code>三个内容为组合，锁定一个文档，操作是添加还是修改。</p></blockquote> <h5 id="_4-6-1-新建文档"><a href="#_4-6-1-新建文档" class="header-anchor">#</a> 4.6.1 新建文档</h5> <blockquote><p>自动生成_id</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 添加文档，自动生成id      不推荐这种自动生成的id 
POST /book/_doc
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;盘龙&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;我吃西红柿&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;count&quot;</span><span class="token operator">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>
  <span class="token property">&quot;on-sale&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2000-01-01&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;descr&quot;</span><span class="token operator">:</span> <span class="token string">&quot;山重水复疑无路，柳暗花明又一村&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>手动指定_id</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 添加文档，手动指定id     推荐使用
PUT /book/_/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;红楼梦&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;曹雪芹&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;count&quot;</span><span class="token operator">:</span> <span class="token number">10000000</span><span class="token punctuation">,</span>
  <span class="token property">&quot;on-sale&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1985-01-01&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;descr&quot;</span><span class="token operator">:</span> <span class="token string">&quot;一个是阆苑仙葩，一个是美玉无瑕&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_4-6-2-修改文档"><a href="#_4-6-2-修改文档" class="header-anchor">#</a> 4.6.2 修改文档</h5> <blockquote><p>覆盖式修改</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 修改文档   覆盖式修改  如果没有指定某个属性 这个属性会被覆盖掉  覆盖没了
PUT /book/novel/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;红楼梦&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;曹雪芹&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;count&quot;</span><span class="token operator">:</span> <span class="token number">4353453</span><span class="token punctuation">,</span>
  <span class="token property">&quot;on-sale&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1985-01-01&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;descr&quot;</span><span class="token operator">:</span> <span class="token string">&quot;一个是阆苑仙葩，一个是美玉无瑕&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>doc修改方式</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 修改文档，基于doc方式       不会覆盖之前的内容 指定哪一个属性 修改哪一个属性
POST /book/novel/<span class="token number">1</span>/_update      # <span class="token number">7</span> 之前的写法
<span class="token punctuation">{</span>
  <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
     # 指定上需要修改的field和对应的值
    <span class="token property">&quot;count&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1234565&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


# 现在 都这样写
POST book/_update/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;斗破苍穹&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_4-6-3-删除文档"><a href="#_4-6-3-删除文档" class="header-anchor">#</a> 4.6.3 删除文档</h5> <blockquote><p>根据id删除</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 根据id删除文档
DELETE book/_doc/<span class="token number">1</span>      # 删除id 为<span class="token number">1</span> 的文档
</code></pre></div><h5 id="_4-6-4-补充"><a href="#_4-6-4-补充" class="header-anchor">#</a> 4.6.4 补充</h5> <blockquote><p>在kibana 可视化界面中可以看到 创建的索引信息</p></blockquote> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201026160812996.png" alt="image-20201026160812996"></p> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201026160904473.png" alt="image-20201026160904473"></p> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201026160922091.png" alt="image-20201026160922091"></p> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201026160941223.png" alt="image-20201026160941223"></p> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201026161008465.png" alt="image-20201026161008465"></p> <h3 id="五、java操作elasticsearch【重点】"><a href="#五、java操作elasticsearch【重点】" class="header-anchor">#</a> 五、Java操作ElasticSearch【<code>重点</code>】</h3> <hr> <h4 id="_5-1-java连接es"><a href="#_5-1-java连接es" class="header-anchor">#</a> 5.1 Java连接ES</h4> <blockquote><p>创建springboot工程</p></blockquote> <blockquote><p>导入依赖</p></blockquote> <div class="language-xml extra-class"><pre class="language-xml"><code>这里注意  springboot版本 默认了es 的 一些版本，需要咱们自己统一定义  要不然会有版本冲突 所以 在pom 文件中 统一 es 版本

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span>7.4.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>



<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
     <span class="token comment">&lt;!-- elasticsearch --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>7.4.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    
     <span class="token comment">&lt;!--    elasticsearch 高阶API--&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--导入 es  的 高阶 api  来 操作 es
                要进行配置
                如果使用spsringdata 操作es  配置会比较简单 只需要在配置文件指定es 的地址就好了
                我们是自己配的 所以自己对es 做配置
            --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch-rest-high-level-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>7.4.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--        3. junit--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--        4. lombok--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.16.22<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><blockquote><p>创建配置类，测试连接ES</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>glls<span class="token punctuation">.</span>esdemo<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpHost</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RequestOptions</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestClientBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestHighLevelClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author glls

 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ElasticSearchConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">//RequestOptions   这个类 主要封装了 访问 ES 的  一些头信息   一些 设置信息</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">RequestOptions</span> <span class="token constant">COMMON_OPTIONS</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token comment">// 请求设置项</span>
        <span class="token class-name">RequestOptions<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">.</span><span class="token function">toBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        builder.addHeader(&quot;Authorization&quot;,&quot;Bearer&quot;+TOKEN);</span>
<span class="token comment">//        builder.setHttpAsyncResponseConsumerFactory(new HttpAsyncResponseConsumerFactory</span>
<span class="token comment">//                .HeapBufferedResponseConsumerFactory(30*1024*1024*1024));</span>

        <span class="token constant">COMMON_OPTIONS</span> <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">esRestClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RestClientBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        builder <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.5.205&quot;</span><span class="token punctuation">,</span><span class="token number">9200</span><span class="token punctuation">,</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RestHighLevelClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(new HttpHost(&quot;192.168.56.10&quot;, 9200, &quot;http&quot;)));</span>

        <span class="token keyword">return</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// 测试 能不能得到 RestHighLevelClient</span>
    <span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">EsdemoApplicationTests</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>    
</code></pre></div><h4 id="_5-2-java操作索引"><a href="#_5-2-java操作索引" class="header-anchor">#</a> 5.2 Java操作索引</h4> <h5 id="_5-2-1-创建索引"><a href="#_5-2-1-创建索引" class="header-anchor">#</a> 5.2.1 创建索引</h5> <blockquote><p>代码如下</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token comment">/**
     * 索引的创建
     *
     * */</span>
	    <span class="token comment">/**
         * {
         *  &quot;properties&quot;:{
         *      &quot;name&quot;:{
         *          &quot;type&quot;:&quot;text&quot;
         *      },
         *      &quot;age&quot;:{
         *          &quot;type&quot;:&quot;integer&quot;
         *      },
         *      &quot;birthday&quot;:{
         *          &quot;type&quot;:&quot;date&quot;,
         *          &quot;format&quot;:&quot;yyyy-MM-dd&quot;
         *      }
         *  }
         *
         * }
         *
         * */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">demo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建索引</span>
        <span class="token class-name">String</span> index <span class="token operator">=</span> <span class="token string">&quot;person&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//1. 准备关于索引的settings</span>
        <span class="token class-name">Settings<span class="token punctuation">.</span>Builder</span> settings <span class="token operator">=</span> <span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;number_of_shards&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;number_of_replicas&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 准备关于索引的结构mappings</span>
        <span class="token class-name">XContentBuilder</span> mappings <span class="token operator">=</span> <span class="token class-name">JsonXContent</span><span class="token punctuation">.</span><span class="token function">contentBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">// 和 endObject 成对出现</span>
                <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;properties&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;integer&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;birthday&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;date&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;format&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//3. 将settings和mappings封装到一个Request对象</span>
        <span class="token comment">// 不同的操作 准备的request 对象不一样 与下文对比</span>
        <span class="token class-name">CreateIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateIndexRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">settings</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mapping</span><span class="token punctuation">(</span>mappings<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//  如果是6版本 还需要在这个方法指定type                      //.mapping(type,mappings)</span>

        <span class="token comment">//4. 通过client对象去连接ES并执行创建索引</span>
        <span class="token comment">// 通过client 对象 把上面准备的 request 对象 发到es执行  </span>
        <span class="token class-name">CreateIndexResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5. 输出</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;resp:&quot;</span> <span class="token operator">+</span> resp<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre></div><h5 id="_5-2-2-检查索引是否存在"><a href="#_5-2-2-检查索引是否存在" class="header-anchor">#</a> 5.2.2 检查索引是否存在</h5> <blockquote><p>代码如下</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token comment">/**
     * 判断 索引是否存在
     * */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">demo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//1. 准备request对象</span>
        <span class="token class-name">String</span> index <span class="token operator">=</span> <span class="token string">&quot;person&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">GetIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetIndexRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2. 通过client去操作</span>
        <span class="token keyword">boolean</span> exists <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//3. 输出</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>exists<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h5 id="_5-2-3-删除索引"><a href="#_5-2-3-删除索引" class="header-anchor">#</a> 5.2.3 删除索引</h5> <blockquote><p>代码如下</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 准备request对象</span>
    <span class="token class-name">DeleteIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteIndexRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 通过client对象执行</span>
    <span class="token class-name">AcknowledgedResponse</span> delete <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 获取返回结果</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>delete<span class="token punctuation">.</span><span class="token function">isAcknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5-3-java操作文档"><a href="#_5-3-java操作文档" class="header-anchor">#</a> 5.3 Java操作文档</h4> <h5 id="_5-3-1-添加文档操作"><a href="#_5-3-1-添加文档操作" class="header-anchor">#</a> 5.3.1 添加文档操作</h5> <blockquote><p>代码如下</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 添加fastjson 依赖，  jackson 也可以 用法大致一样 </span>
 <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>alibaba<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>fastjson<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.2</span><span class="token number">.31</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
     
<span class="token comment">// 创建实体类</span>
 <span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>format <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span>     <span class="token comment">// fastjson 转换对象时  对日期类型字段的 格式转换</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> birthday<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token comment">// 测试方法    </span>
 <span class="token comment">/**
     * 添加文档
     *
     * */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">demo4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> index <span class="token operator">=</span> <span class="token string">&quot;person&quot;</span><span class="token punctuation">;</span>

            <span class="token comment">//1. 准备一个json数据</span>
            <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2. 准备一个request对象（手动指定id）</span>
            <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//3. 通过client对象执行添加</span>
            <span class="token class-name">IndexResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//4. 输出返回结果</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">//添加doc 方式2</span>
 <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAddDoc2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;birthday&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1999-11-11&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//构建 request 对象</span>
        <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IndexResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


</code></pre></div><h5 id="_5-3-2-修改文档"><a href="#_5-3-2-修改文档" class="header-anchor">#</a> 5.3.2 修改文档</h5> <blockquote><p>代码如下</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
     * 修改文档
     * */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">demo5</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> index <span class="token operator">=</span> <span class="token string">&quot;person&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//1. 创建一个Map，指定需要修改的内容</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> doc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        doc<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;张大三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> docId <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">//2. 创建request对象，封装数据</span>
        <span class="token class-name">UpdateRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>docId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        request<span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3. 通过client对象执行</span>
        <span class="token class-name">UpdateResponse</span> update <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4. 输出返回结果</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><ol><li>准备条件数据</li> <li>构建reuqest</li> <li>封装数据到request</li> <li>client 发送请求 得到结果</li> <li>解析结果</li></ol> <h5 id="_5-3-3-删除文档"><a href="#_5-3-3-删除文档" class="header-anchor">#</a> 5.3.3 删除文档</h5> <blockquote><p>代码如下</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 封装Request对象</span>
    <span class="token class-name">DeleteRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>type<span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. client执行</span>
    <span class="token class-name">DeleteResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 输出结果</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5-4-java批量操作文档"><a href="#_5-4-java批量操作文档" class="header-anchor">#</a> 5.4 Java批量操作文档</h4> <h5 id="_5-4-1-批量添加"><a href="#_5-4-1-批量添加" class="header-anchor">#</a> 5.4.1 批量添加</h5> <blockquote><p>代码如下</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token comment">/**
     * 批量添加
     *
     * */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bulkCreateDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> index<span class="token operator">=</span><span class="token string">&quot;person&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//1. 准备多个json数据</span>
        <span class="token class-name">Person</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;王五&quot;</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Person</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&quot;赵六&quot;</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Person</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;田七&quot;</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> json1 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json2 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json3 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2. 创建Request，将准备好的数据封装进去</span>
        <span class="token class-name">BulkRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json1<span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>p2<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json2<span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>p3<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json3<span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3. 用client执行</span>
        <span class="token class-name">BulkResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4. 输出结果</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h5 id="_5-4-2-批量删除"><a href="#_5-4-2-批量删除" class="header-anchor">#</a> 5.4.2 批量删除</h5> <blockquote><p>代码如下</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bulkDeleteDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 封装Request对象</span>
    <span class="token class-name">BulkRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>type<span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>type<span class="token punctuation">,</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>type<span class="token punctuation">,</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. client执行</span>
    <span class="token class-name">BulkResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 输出</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5-5-elasticsearch练习"><a href="#_5-5-elasticsearch练习" class="header-anchor">#</a> 5.5 ElasticSearch练习</h4> <blockquote><p>创建索引，指定数据结构</p> <p>索引名：sms-logs-index</p> <p>类型名：sms-logs-type</p> <p>结构如下：</p></blockquote> <table><thead><tr><th style="text-align:center;">索引结构图</th></tr></thead> <tbody><tr><td style="text-align:center;"><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/1587137696912.png" alt="1587137696912"></td></tr></tbody></table> <h5 id="_5-5-1代码"><a href="#_5-5-1代码" class="header-anchor">#</a> 5.5.1代码</h5> <blockquote><p>实体类</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>package com.glls.esdemo.pojo<span class="token punctuation">;</span>

<span class="token function">import</span> lombok.AllArgsConstructor<span class="token punctuation">;</span>
<span class="token function">import</span> lombok.Data<span class="token punctuation">;</span>
<span class="token function">import</span> lombok.NoArgsConstructor<span class="token punctuation">;</span>

<span class="token function">import</span> java.util.Date<span class="token punctuation">;</span>

/**
 * @author glls
 * @email <span class="token number">524840158</span>@qq.com
 * @company xxx
 * @create <span class="token number">2020</span>-10-26 <span class="token number">22</span>:55
 *
 *
 * 准备 测试练习数据
 */

@Data
@AllArgsConstructor
@NoArgsConstructor
public class SmsLogs <span class="token punctuation">{</span>

    // 唯一ID
    private String <span class="token function">id</span><span class="token punctuation">;</span>
    // 创建时间
    private Date createDate<span class="token punctuation">;</span>

    private Date sendDate<span class="token punctuation">;</span>  // 发送时间

    private String longCode<span class="token punctuation">;</span>  //  发送的长号码

    private String mobile<span class="token punctuation">;</span>  // 下发手机号

    private String corpName<span class="token punctuation">;</span>   // 发送公司名称

    private String smsContent<span class="token punctuation">;</span>  // 下发短信内容

    private Integer state<span class="token punctuation">;</span>  // 短信下发状态 <span class="token number">0</span> 成功  <span class="token number">1</span> 失败

    private Integer operatorId<span class="token punctuation">;</span>   // 运营商编号  <span class="token number">1</span> 移动  <span class="token number">2</span> 联通 <span class="token number">3</span> 电信

    private String province<span class="token punctuation">;</span>  // 省份

    private String ipAddr<span class="token punctuation">;</span>  // 下发服务器IP地址

    private Integer replyTotal<span class="token punctuation">;</span>  // 短信状态报告返回时长（秒）

    private Integer fee<span class="token punctuation">;</span>  // 费用

<span class="token punctuation">}</span>

</code></pre></div><blockquote><p>测试数据</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>package com.glls.esdemo<span class="token punctuation">;</span>

<span class="token function">import</span> com.alibaba.fastjson.JSON<span class="token punctuation">;</span>
<span class="token function">import</span> com.glls.esdemo.pojo.SmsLogs<span class="token punctuation">;</span>
<span class="token function">import</span> org.elasticsearch.action.bulk.BulkRequest<span class="token punctuation">;</span>
<span class="token function">import</span> org.elasticsearch.action.index.IndexRequest<span class="token punctuation">;</span>
<span class="token function">import</span> org.elasticsearch.client.RequestOptions<span class="token punctuation">;</span>
<span class="token function">import</span> org.elasticsearch.client.RestHighLevelClient<span class="token punctuation">;</span>
<span class="token function">import</span> org.elasticsearch.client.indices.CreateIndexRequest<span class="token punctuation">;</span>
<span class="token function">import</span> org.elasticsearch.client.indices.CreateIndexResponse<span class="token punctuation">;</span>
<span class="token function">import</span> org.elasticsearch.common.settings.Settings<span class="token punctuation">;</span>
<span class="token function">import</span> org.elasticsearch.common.xcontent.XContentBuilder<span class="token punctuation">;</span>
<span class="token function">import</span> org.elasticsearch.common.xcontent.XContentType<span class="token punctuation">;</span>
<span class="token function">import</span> org.elasticsearch.common.xcontent.json.JsonXContent<span class="token punctuation">;</span>
<span class="token function">import</span> org.junit.jupiter.api.Test<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.boot.test.context.SpringBootTest<span class="token punctuation">;</span>

<span class="token function">import</span> javax.annotation.Resource<span class="token punctuation">;</span>
<span class="token function">import</span> java.io.IOException<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.Date<span class="token punctuation">;</span>

/**
 *
 * 检索操作
 * */

@SpringBootTest
class EsdemoApplicationTests2 <span class="token punctuation">{</span>
    @Resource
    private RestHighLevelClient client<span class="token punctuation">;</span>

    String index <span class="token operator">=</span> <span class="token string">&quot;sms-logs-index&quot;</span><span class="token punctuation">;</span>

    @Test
    public void createSmsLogsIndex<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>

        //1. settings
        Settings.Builder settings <span class="token operator">=</span> Settings.builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .put<span class="token punctuation">(</span><span class="token string">&quot;number_of_shards&quot;</span>, <span class="token number">3</span><span class="token punctuation">)</span>
                .put<span class="token punctuation">(</span><span class="token string">&quot;number_of_replicas&quot;</span>, <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        //2. mapping.
        XContentBuilder mapping <span class="token operator">=</span> JsonXContent.contentBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .startObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .startObject<span class="token punctuation">(</span><span class="token string">&quot;properties&quot;</span><span class="token punctuation">)</span>
                .startObject<span class="token punctuation">(</span><span class="token string">&quot;createDate&quot;</span><span class="token punctuation">)</span>
                .field<span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span>, <span class="token string">&quot;date&quot;</span><span class="token punctuation">)</span>
                .endObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .startObject<span class="token punctuation">(</span><span class="token string">&quot;sendDate&quot;</span><span class="token punctuation">)</span>
                .field<span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span>, <span class="token string">&quot;date&quot;</span><span class="token punctuation">)</span>
                .endObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .startObject<span class="token punctuation">(</span><span class="token string">&quot;longCode&quot;</span><span class="token punctuation">)</span>
                .field<span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span>, <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">)</span>
                .endObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .startObject<span class="token punctuation">(</span><span class="token string">&quot;mobile&quot;</span><span class="token punctuation">)</span>
                .field<span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span>, <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">)</span>
                .endObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .startObject<span class="token punctuation">(</span><span class="token string">&quot;corpName&quot;</span><span class="token punctuation">)</span>
                .field<span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span>, <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">)</span>
                .endObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .startObject<span class="token punctuation">(</span><span class="token string">&quot;smsContent&quot;</span><span class="token punctuation">)</span>
                .field<span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span>, <span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span>
                .field<span class="token punctuation">(</span><span class="token string">&quot;analyzer&quot;</span>, <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">)</span>
                .endObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .startObject<span class="token punctuation">(</span><span class="token string">&quot;state&quot;</span><span class="token punctuation">)</span>
                .field<span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span>, <span class="token string">&quot;integer&quot;</span><span class="token punctuation">)</span>
                .endObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .startObject<span class="token punctuation">(</span><span class="token string">&quot;operatorId&quot;</span><span class="token punctuation">)</span>
                .field<span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span>, <span class="token string">&quot;integer&quot;</span><span class="token punctuation">)</span>
                .endObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .startObject<span class="token punctuation">(</span><span class="token string">&quot;province&quot;</span><span class="token punctuation">)</span>
                .field<span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span>, <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">)</span>
                .endObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .startObject<span class="token punctuation">(</span><span class="token string">&quot;ipAddr&quot;</span><span class="token punctuation">)</span>
                .field<span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span>, <span class="token string">&quot;ip&quot;</span><span class="token punctuation">)</span>
                .endObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .startObject<span class="token punctuation">(</span><span class="token string">&quot;replyTotal&quot;</span><span class="token punctuation">)</span>
                .field<span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span>, <span class="token string">&quot;integer&quot;</span><span class="token punctuation">)</span>
                .endObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .startObject<span class="token punctuation">(</span><span class="token string">&quot;fee&quot;</span><span class="token punctuation">)</span>
                .field<span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span>, <span class="token string">&quot;long&quot;</span><span class="token punctuation">)</span>
                .endObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .endObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
                .endObject<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        //3. 添加索引.
        CreateIndexRequest request <span class="token operator">=</span> new CreateIndexRequest<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request.settings<span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request.mapping<span class="token punctuation">(</span>mapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
        CreateIndexResponse resp <span class="token operator">=</span> client.indices<span class="token punctuation">(</span><span class="token punctuation">)</span>.create<span class="token punctuation">(</span>request, RequestOptions.DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        System.out.println<span class="token punctuation">(</span><span class="token string">&quot;resp:&quot;</span> + resp.toString<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        System.out.println<span class="token punctuation">(</span><span class="token string">&quot;OK!!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    @Test
    public void addTestData<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>
        BulkRequest request <span class="token operator">=</span> new BulkRequest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        SmsLogs smsLogs <span class="token operator">=</span> new SmsLogs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs.setMobile<span class="token punctuation">(</span><span class="token string">&quot;13800000000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs.setCorpName<span class="token punctuation">(</span><span class="token string">&quot;途虎养车&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs.setCreateDate<span class="token punctuation">(</span>new Date<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        smsLogs.setSendDate<span class="token punctuation">(</span>new Date<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        smsLogs.setIpAddr<span class="token punctuation">(</span><span class="token string">&quot;10.126.2.9&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs.setLongCode<span class="token punctuation">(</span><span class="token string">&quot;10690000988&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs.setReplyTotal<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs.setState<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs.setSmsContent<span class="token punctuation">(</span><span class="token string">&quot;【途虎养车】亲爱的张三先生/女士，您在途虎购买的货品(单号TH123456)已 到指定安装店多日，&quot;</span> + <span class="token string">&quot;现需与您确认订单的安装情况，请点击链接按实际情况选择（此链接有效期为72H）。您也可以登录途 虎APP进入&quot;</span> + <span class="token string">&quot;“我的-待安装订单”进行预约安装。若您在服务过程中有任何疑问，请致电400-111-8868向途虎咨 询。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs.setProvince<span class="token punctuation">(</span><span class="token string">&quot;北京&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs.setOperatorId<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs.setFee<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request.add<span class="token punctuation">(</span>new IndexRequest<span class="token punctuation">(</span>index<span class="token punctuation">)</span>.id<span class="token punctuation">(</span><span class="token string">&quot;21&quot;</span><span class="token punctuation">)</span>.source<span class="token punctuation">(</span>JSON.toJSONString<span class="token punctuation">(</span>smsLogs<span class="token punctuation">)</span>, XContentType.JSON<span class="token punctuation">))</span><span class="token punctuation">;</span>

        smsLogs.setMobile<span class="token punctuation">(</span><span class="token string">&quot;13700000001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs.setProvince<span class="token punctuation">(</span><span class="token string">&quot;上海&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs.setSmsContent<span class="token punctuation">(</span><span class="token string">&quot;【途虎养车】亲爱的刘红先生/女士，您在途虎购买的货品(单号TH1234526)已 到指定安装店多日，&quot;</span> + <span class="token string">&quot;现需与您确认订单的安装情况，请点击链接按实际情况选择（此链接有效期为72H）。您也可以登录途 虎APP进入&quot;</span> + <span class="token string">&quot;“我的-待安装订单”进行预约安装。若您在服务过程中有任何疑问，请致电400-111-8868向途虎咨 询。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request.add<span class="token punctuation">(</span>new IndexRequest<span class="token punctuation">(</span>index<span class="token punctuation">)</span>.id<span class="token punctuation">(</span><span class="token string">&quot;22&quot;</span><span class="token punctuation">)</span>.source<span class="token punctuation">(</span>JSON.toJSONString<span class="token punctuation">(</span>smsLogs<span class="token punctuation">)</span>, XContentType.JSON<span class="token punctuation">))</span><span class="token punctuation">;</span>


        // -------------------------------------------------------------------------------------------------------------------

        SmsLogs smsLogs1 <span class="token operator">=</span> new SmsLogs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs1.setMobile<span class="token punctuation">(</span><span class="token string">&quot;13100000000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs1.setCorpName<span class="token punctuation">(</span><span class="token string">&quot;盒马鲜生&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs1.setCreateDate<span class="token punctuation">(</span>new Date<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        smsLogs1.setSendDate<span class="token punctuation">(</span>new Date<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        smsLogs1.setIpAddr<span class="token punctuation">(</span><span class="token string">&quot;10.126.2.9&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs1.setLongCode<span class="token punctuation">(</span><span class="token string">&quot;10660000988&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs1.setReplyTotal<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs1.setState<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs1.setSmsContent<span class="token punctuation">(</span><span class="token string">&quot;【盒马】您尾号12345678的订单已开始配送，请在您指定的时间收货不要走开 哦~配送员：&quot;</span> + <span class="token string">&quot;刘三，电话：13800000000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs1.setProvince<span class="token punctuation">(</span><span class="token string">&quot;北京&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs1.setOperatorId<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs1.setFee<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request.add<span class="token punctuation">(</span>new IndexRequest<span class="token punctuation">(</span>index<span class="token punctuation">)</span>.id<span class="token punctuation">(</span><span class="token string">&quot;23&quot;</span><span class="token punctuation">)</span>.source<span class="token punctuation">(</span>JSON.toJSONString<span class="token punctuation">(</span>smsLogs1<span class="token punctuation">)</span>, XContentType.JSON<span class="token punctuation">))</span><span class="token punctuation">;</span>

        smsLogs1.setMobile<span class="token punctuation">(</span><span class="token string">&quot;18600000001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs1.setProvince<span class="token punctuation">(</span><span class="token string">&quot;上海&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs1.setSmsContent<span class="token punctuation">(</span><span class="token string">&quot;【盒马】您尾号7775678的订单已开始配送，请在您指定的时间收货不要走开 哦~配送员：&quot;</span> + <span class="token string">&quot;王五，电话：13800000001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request.add<span class="token punctuation">(</span>new IndexRequest<span class="token punctuation">(</span>index<span class="token punctuation">)</span>.id<span class="token punctuation">(</span><span class="token string">&quot;24&quot;</span><span class="token punctuation">)</span>.source<span class="token punctuation">(</span>JSON.toJSONString<span class="token punctuation">(</span>smsLogs1<span class="token punctuation">)</span>, XContentType.JSON<span class="token punctuation">))</span><span class="token punctuation">;</span>

        // -------------------------------------------------------------------------------------------------------------------

        SmsLogs smsLogs2 <span class="token operator">=</span> new SmsLogs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs2.setMobile<span class="token punctuation">(</span><span class="token string">&quot;15300000000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs2.setCorpName<span class="token punctuation">(</span><span class="token string">&quot;滴滴打车&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs2.setCreateDate<span class="token punctuation">(</span>new Date<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        smsLogs2.setSendDate<span class="token punctuation">(</span>new Date<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        smsLogs2.setIpAddr<span class="token punctuation">(</span><span class="token string">&quot;10.126.2.8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs2.setLongCode<span class="token punctuation">(</span><span class="token string">&quot;10660000988&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs2.setReplyTotal<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs2.setState<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs2.setSmsContent<span class="token punctuation">(</span><span class="token string">&quot;【滴滴单车平台】专属限时福利！青桔/小蓝月卡立享5折，特惠畅骑30天。&quot;</span> + <span class="token string">&quot;戳 https://xxxxxx退订TD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs2.setProvince<span class="token punctuation">(</span><span class="token string">&quot;上海&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs2.setOperatorId<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs2.setFee<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request.add<span class="token punctuation">(</span>new IndexRequest<span class="token punctuation">(</span>index<span class="token punctuation">)</span>.id<span class="token punctuation">(</span><span class="token string">&quot;25&quot;</span><span class="token punctuation">)</span>.source<span class="token punctuation">(</span>JSON.toJSONString<span class="token punctuation">(</span>smsLogs2<span class="token punctuation">)</span>, XContentType.JSON<span class="token punctuation">))</span><span class="token punctuation">;</span>

        smsLogs2.setMobile<span class="token punctuation">(</span><span class="token string">&quot;18000000001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs2.setProvince<span class="token punctuation">(</span><span class="token string">&quot;武汉&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs2.setSmsContent<span class="token punctuation">(</span><span class="token string">&quot;【滴滴单车平台】专属限时福利！青桔/小蓝月卡立享5折，特惠畅骑30天。&quot;</span> + <span class="token string">&quot;戳 https://xxxxxx退订TD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request.add<span class="token punctuation">(</span>new IndexRequest<span class="token punctuation">(</span>index<span class="token punctuation">)</span>.id<span class="token punctuation">(</span><span class="token string">&quot;26&quot;</span><span class="token punctuation">)</span>.source<span class="token punctuation">(</span>JSON.toJSONString<span class="token punctuation">(</span>smsLogs2<span class="token punctuation">)</span>, XContentType.JSON<span class="token punctuation">))</span><span class="token punctuation">;</span>


        // -------------------------------------------------------------------------------------------------------------------

        SmsLogs smsLogs3 <span class="token operator">=</span> new SmsLogs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs3.setMobile<span class="token punctuation">(</span><span class="token string">&quot;13900000000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs3.setCorpName<span class="token punctuation">(</span><span class="token string">&quot;招商银行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs3.setCreateDate<span class="token punctuation">(</span>new Date<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        smsLogs3.setSendDate<span class="token punctuation">(</span>new Date<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        smsLogs3.setIpAddr<span class="token punctuation">(</span><span class="token string">&quot;10.126.2.8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs3.setLongCode<span class="token punctuation">(</span><span class="token string">&quot;10690000988&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs3.setReplyTotal<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs3.setState<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs3.setSmsContent<span class="token punctuation">(</span><span class="token string">&quot;【招商银行】尊贵的李四先生,恭喜您获得华为P30 Pro抽奖资格,还可领100 元打&quot;</span> + <span class="token string">&quot;车红包,仅限1天&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs3.setProvince<span class="token punctuation">(</span><span class="token string">&quot;上海&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs3.setOperatorId<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs3.setFee<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request.add<span class="token punctuation">(</span>new IndexRequest<span class="token punctuation">(</span>index<span class="token punctuation">)</span>.id<span class="token punctuation">(</span><span class="token string">&quot;27&quot;</span><span class="token punctuation">)</span>.source<span class="token punctuation">(</span>JSON.toJSONString<span class="token punctuation">(</span>smsLogs3<span class="token punctuation">)</span>, XContentType.JSON<span class="token punctuation">))</span><span class="token punctuation">;</span>

        smsLogs3.setMobile<span class="token punctuation">(</span><span class="token string">&quot;13990000001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs3.setProvince<span class="token punctuation">(</span><span class="token string">&quot;武汉&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs3.setSmsContent<span class="token punctuation">(</span><span class="token string">&quot;【招商银行】尊贵的李四先生,恭喜您获得华为P30 Pro抽奖资格,还可领100 元打&quot;</span> + <span class="token string">&quot;车红包,仅限1天&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request.add<span class="token punctuation">(</span>new IndexRequest<span class="token punctuation">(</span>index<span class="token punctuation">)</span>.id<span class="token punctuation">(</span><span class="token string">&quot;28&quot;</span><span class="token punctuation">)</span>.source<span class="token punctuation">(</span>JSON.toJSONString<span class="token punctuation">(</span>smsLogs3<span class="token punctuation">)</span>, XContentType.JSON<span class="token punctuation">))</span><span class="token punctuation">;</span>

        // -------------------------------------------------------------------------------------------------------------------

        SmsLogs smsLogs4 <span class="token operator">=</span> new SmsLogs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs4.setMobile<span class="token punctuation">(</span><span class="token string">&quot;13700000000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs4.setCorpName<span class="token punctuation">(</span><span class="token string">&quot;中国平安保险有限公司&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs4.setCreateDate<span class="token punctuation">(</span>new Date<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        smsLogs4.setSendDate<span class="token punctuation">(</span>new Date<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        smsLogs4.setIpAddr<span class="token punctuation">(</span><span class="token string">&quot;10.126.2.8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs4.setLongCode<span class="token punctuation">(</span><span class="token string">&quot;10690000998&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs4.setReplyTotal<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs4.setState<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs4.setSmsContent<span class="token punctuation">(</span><span class="token string">&quot;【中国平安】奋斗的时代，更需要健康的身体。中国平安为您提供多重健康保 障，在奋斗之路上为您保驾护航。退订请回复TD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs4.setProvince<span class="token punctuation">(</span><span class="token string">&quot;武汉&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs4.setOperatorId<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs4.setFee<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request.add<span class="token punctuation">(</span>new IndexRequest<span class="token punctuation">(</span>index<span class="token punctuation">)</span>.id<span class="token punctuation">(</span><span class="token string">&quot;29&quot;</span><span class="token punctuation">)</span>.source<span class="token punctuation">(</span>JSON.toJSONString<span class="token punctuation">(</span>smsLogs4<span class="token punctuation">)</span>, XContentType.JSON<span class="token punctuation">))</span><span class="token punctuation">;</span>

        smsLogs4.setMobile<span class="token punctuation">(</span><span class="token string">&quot;13990000002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs4.setProvince<span class="token punctuation">(</span><span class="token string">&quot;武汉&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs4.setSmsContent<span class="token punctuation">(</span><span class="token string">&quot;【招商银行】尊贵的王五先生,恭喜您获得iphone 56抽奖资格,还可领5 元打&quot;</span> + <span class="token string">&quot;车红包,仅限100天&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request.add<span class="token punctuation">(</span>new IndexRequest<span class="token punctuation">(</span>index<span class="token punctuation">)</span>.id<span class="token punctuation">(</span><span class="token string">&quot;30&quot;</span><span class="token punctuation">)</span>.source<span class="token punctuation">(</span>JSON.toJSONString<span class="token punctuation">(</span>smsLogs4<span class="token punctuation">)</span>, XContentType.JSON<span class="token punctuation">))</span><span class="token punctuation">;</span>

        // -------------------------------------------------------------------------------------------------------------------


        SmsLogs smsLogs5 <span class="token operator">=</span> new SmsLogs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs5.setMobile<span class="token punctuation">(</span><span class="token string">&quot;13600000000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs5.setCorpName<span class="token punctuation">(</span><span class="token string">&quot;中国移动&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs5.setCreateDate<span class="token punctuation">(</span>new Date<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        smsLogs5.setSendDate<span class="token punctuation">(</span>new Date<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        smsLogs5.setIpAddr<span class="token punctuation">(</span><span class="token string">&quot;10.126.2.8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs5.setLongCode<span class="token punctuation">(</span><span class="token string">&quot;10650000998&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs5.setReplyTotal<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs5.setState<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs5.setSmsContent<span class="token punctuation">(</span><span class="token string">&quot;【北京移动】尊敬的客户137****0000，5月话费账单已送达您的139邮箱，&quot;</span> + <span class="token string">&quot;点击查看账单详情 http://y.10086.cn/; &quot;</span> + <span class="token string">&quot; 回Q关闭通知，关注“中国移动139邮箱”微信随时查账单【中国移动 139邮箱】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs5.setProvince<span class="token punctuation">(</span><span class="token string">&quot;武汉&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs5.setOperatorId<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs5.setFee<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request.add<span class="token punctuation">(</span>new IndexRequest<span class="token punctuation">(</span>index<span class="token punctuation">)</span>.id<span class="token punctuation">(</span><span class="token string">&quot;31&quot;</span><span class="token punctuation">)</span>.source<span class="token punctuation">(</span>JSON.toJSONString<span class="token punctuation">(</span>smsLogs5<span class="token punctuation">)</span>, XContentType.JSON<span class="token punctuation">))</span><span class="token punctuation">;</span>

        smsLogs5.setMobile<span class="token punctuation">(</span><span class="token string">&quot;13990001234&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs5.setProvince<span class="token punctuation">(</span><span class="token string">&quot;山西&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smsLogs5.setSmsContent<span class="token punctuation">(</span><span class="token string">&quot;【北京移动】尊敬的客户137****1234，8月话费账单已送达您的126邮箱，<span class="token entity" title="\&quot;">\&quot;</span> + <span class="token entity" title="\&quot;">\&quot;</span>点击查看账单详情 http://y.10086.cn/; <span class="token entity" title="\&quot;">\&quot;</span> + <span class="token entity" title="\&quot;">\&quot;</span> 回Q关闭通知，关注“中国移动126邮箱”微信随时查账单【中国移动 126邮箱】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request.add<span class="token punctuation">(</span>new IndexRequest<span class="token punctuation">(</span>index<span class="token punctuation">)</span>.id<span class="token punctuation">(</span><span class="token string">&quot;32&quot;</span><span class="token punctuation">)</span>.source<span class="token punctuation">(</span>JSON.toJSONString<span class="token punctuation">(</span>smsLogs5<span class="token punctuation">)</span>, XContentType.JSON<span class="token punctuation">))</span><span class="token punctuation">;</span>
        // -------------------------------------------------------------------------------------------------------------------

        client.bulk<span class="token punctuation">(</span>request,RequestOptions.DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        System.out.println<span class="token punctuation">(</span><span class="token string">&quot;OK!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre></div><h3 id="六、-elasticsearch的各种查询"><a href="#六、-elasticsearch的各种查询" class="header-anchor">#</a> 六、 ElasticSearch的各种查询</h3> <hr> <h4 id="_6-1-term-terms查询【重点】"><a href="#_6-1-term-terms查询【重点】" class="header-anchor">#</a> 6.1 term&amp;terms查询【<code>重点</code>】</h4> <h5 id="_6-1-1-term查询"><a href="#_6-1-1-term查询" class="header-anchor">#</a> 6.1.1 term查询</h5> <blockquote><p>term的查询是代表完全匹配，搜索之前不会对你搜索的关键字进行分词，对你的关键字去文档分词库中去匹配内容。</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># term查询
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>     # limit ？
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>	  # limit x<span class="token punctuation">,</span>?
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>    # 完整匹配
      <span class="token property">&quot;province&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;北京&quot;</span>    # 拿这个 北京 去完整匹配   不会分词匹配
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

#注意 这里对 term 的理解   即 对 field 类型  text 和 keyword 的理解 ，term 是拿这个查询条件不进行分词  去匹配 文档中的内容， 而文档中的内容 如果是text 类型，会对这个 field 进行分词 ，如果分词后的内容 没有和 term 的 查询条件匹配上 ，那么term 查询 就查不出来结果， 如果文档中的内容 是 keyword ，就不会对文档中的进行分词，此时 就需要term 的完整匹配查询  才能查到数据。 总结  term 不对查询条件进行分词，  field是text或者keyword 类型  分别是 对文档内容分词（text）和不分词(keyword)


# 查询结果
<span class="token punctuation">{</span>
  <span class="token property">&quot;took&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>    # 查询用了<span class="token number">2</span>毫秒
  <span class="token property">&quot;timed_out&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    # 是否超时  没有超时
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>    # 分片信息
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>   # 一共使用三个分片
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>   # 成功了三个分片
    <span class="token property">&quot;skipped&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    # 跳过
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>      # 失败
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>           # 查询命中
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>         # 总命中
      <span class="token property">&quot;value&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>      # 命中数
      <span class="token property">&quot;relation&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;eq&quot;</span>  # 查询关系
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;max_score&quot;</span> <span class="token operator">:</span> <span class="token number">0.6931472</span><span class="token punctuation">,</span>    # 匹配分数   匹配度越高  分数越高
    <span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;sms-logs-index&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;21&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token number">0.6931472</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;corpName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;途虎养车&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;createDate&quot;</span> <span class="token operator">:</span> <span class="token number">1607833538978</span><span class="token punctuation">,</span>
          <span class="token property">&quot;fee&quot;</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
          <span class="token property">&quot;ipAddr&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;10.126.2.9&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;longCode&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;10690000988&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;mobile&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;13800000000&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;operatorId&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token property">&quot;province&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;北京&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;replyTotal&quot;</span> <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
          <span class="token property">&quot;sendDate&quot;</span> <span class="token operator">:</span> <span class="token number">1607833538978</span><span class="token punctuation">,</span>
          <span class="token property">&quot;smsContent&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;【途虎养车】亲爱的张三先生/女士，您在途虎购买的货品(单号TH123456)已 到指定安装店多日，现需与您确认订单的安装情况，请点击链接按实际情况选择（此链接有效期为72H）。您也可以登录途 虎APP进入“我的-待安装订单”进行预约安装。若您在服务过程中有任何疑问，请致电400-111-8868向途虎咨 询。&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;state&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;sms-logs-index&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;23&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token number">0.6931472</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;corpName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;盒马鲜生&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;createDate&quot;</span> <span class="token operator">:</span> <span class="token number">1607833539131</span><span class="token punctuation">,</span>
          <span class="token property">&quot;fee&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
          <span class="token property">&quot;ipAddr&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;10.126.2.9&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;longCode&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;10660000988&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;mobile&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;13100000000&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;operatorId&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token property">&quot;province&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;北京&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;replyTotal&quot;</span> <span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
          <span class="token property">&quot;sendDate&quot;</span> <span class="token operator">:</span> <span class="token number">1607833539131</span><span class="token punctuation">,</span>
          <span class="token property">&quot;smsContent&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;【盒马】您尾号12345678的订单已开始配送，请在您指定的时间收货不要走开 哦~配送员：刘三，电话：13800000000&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;state&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java代码实现方式</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建Request对象</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 指定查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;province&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;北京&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行查询</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 获取到_source中的数据，并展示</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-1-2-terms查询"><a href="#_6-1-2-terms查询" class="header-anchor">#</a> 6.1.2 terms查询</h5> <blockquote><p>terms和term的查询机制是一样，都不会将指定的查询关键字进行分词，直接去分词库中匹配，找到相应文档内容。</p> <p>terms是在针对一个字段包含多个值的时候使用。</p> <p>term：where province = 北京；</p> <p>terms：where province = 北京 or province = ？or province = ？      一个字段可以等于多个值  有点类似 in</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># terms查询
POST /sms-logs-index/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;province&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;北京&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;山西&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;武汉&quot;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java实现</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">termsQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 封装查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termsQuery</span><span class="token punctuation">(</span><span class="token string">&quot;province&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;北京&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;山西&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行查询</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出_source</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-2-match查询【重点】"><a href="#_6-2-match查询【重点】" class="header-anchor">#</a> 6.2 match查询【<code>重点</code>】</h4> <blockquote><p>match查询属于高层查询，他会根据你查询的字段类型不一样，采用不同的查询方式。</p> <ul><li>查询的是日期或者是数值的话，他会将你基于的字符串查询内容转换为日期或者数值对待。</li> <li>如果查询的内容是一个不能被分词的内容（keyword），match查询不会对你指定的查询关键字进行分词。</li> <li>如果查询的内容时一个可以被分词的内容（text），match会将你指定的查询内容根据一定的方式去分词，去分词库中匹配指定的内容。</li></ul> <p>match查询，实际底层就是多个term查询，将多个term查询的结果给你封装到了一起。</p></blockquote> <h5 id="_6-2-1-match-all查询"><a href="#_6-2-1-match-all查询" class="header-anchor">#</a> 6.2.1 match_all查询</h5> <blockquote><p>查询全部内容，不指定任何查询条件。</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># match_all查询
POST /sms-logs-index/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//  java代码实现</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 指定查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// ES默认只查询10条数据，如果想查询更多，添加size</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行查询</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-2-2-match查询"><a href="#_6-2-2-match查询" class="header-anchor">#</a> 6.2.2 match查询</h5> <blockquote><p>指定一个Field作为筛选的条件</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># match查询
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;smsContent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;收货安装&quot;</span>     # smsContent 是 text 类型，match 会自动识别  会对查询条件也进行分词 也就是  把收获安装 按照分词器规则 拆分，比如 拆为  收获  和 安装 去和文档进行匹配
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 指定查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//-----------------------------------------------</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;smsContent&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;收货安装&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//-----------------------------------------------</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3. 执行查询</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-2-3-布尔match查询"><a href="#_6-2-3-布尔match查询" class="header-anchor">#</a> 6.2.3 布尔match查询</h5> <blockquote><p>基于一个Field匹配的内容，采用and或者or的方式连接</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 布尔match查询
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;smsContent&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;中国 健康&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;operator&quot;</span><span class="token operator">:</span> <span class="token string">&quot;and&quot;</span>      # 内容既包含中国也包含健康
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


# 布尔match查询
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;smsContent&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;中国 健康&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;operator&quot;</span><span class="token operator">:</span> <span class="token string">&quot;or&quot;</span>		# 内容包括健康或者包括中国
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java代码实现</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">booleanMatchQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 指定查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//-----------------------------------------------                               选择AND或者OR</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;smsContent&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;中国 健康&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">operator</span><span class="token punctuation">(</span><span class="token class-name">Operator</span><span class="token punctuation">.</span><span class="token constant">OR</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//-----------------------------------------------</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3. 执行查询</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-2-4-multi-match查询"><a href="#_6-2-4-multi-match查询" class="header-anchor">#</a> 6.2.4 multi_match查询</h5> <blockquote><p>match针对一个field做检索，multi_match针对多个field进行检索，多个field对应一个text。</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># multi_match 查询
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;multi_match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;北京&quot;</span><span class="token punctuation">,</span>					# 指定text
      <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;province&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;smsContent&quot;</span><span class="token punctuation">]</span>    # 指定field们
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// java代码实现</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">multiMatchQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 指定查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//-----------------------------------------------</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;北京&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;province&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;smsContent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//-----------------------------------------------</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3. 执行查询</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-3-其他查询"><a href="#_6-3-其他查询" class="header-anchor">#</a> 6.3 其他查询</h4> <h5 id="_6-3-1-id查询"><a href="#_6-3-1-id查询" class="header-anchor">#</a> 6.3.1 id查询</h5> <blockquote><p>根据id查询 where id = ?</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># id查询      
GET /sms-logs-index/sms-logs-type/<span class="token number">1</span>        # GET /sms-logs-index/_doc/<span class="token number">1</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java代码实现</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建GetRequest</span>
    <span class="token class-name">GetRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 执行查询</span>
    <span class="token class-name">GetResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 输出结果</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-3-2-ids查询"><a href="#_6-3-2-ids查询" class="header-anchor">#</a> 6.3.2 ids查询</h5> <blockquote><p>根据多个id查询，类似MySQL中的where id in（id1，id2，id2...）</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># ids查询
POST /sms-logs-index/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;ids&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;values&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java代码实现</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findByIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    

    <span class="token comment">//2. 指定查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//----------------------------------------------------------</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">idsQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIds</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//----------------------------------------------------------</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-3-3-prefix查询"><a href="#_6-3-3-prefix查询" class="header-anchor">#</a> 6.3.3 prefix查询</h5> <blockquote><p>前缀查询，可以通过一个关键字去指定一个Field的前缀，从而查询到指定的文档。</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code>#prefix 查询
POST /sms-logs-index/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;prefix&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;corpName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;途虎&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java实现前缀查询</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findByPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    

    <span class="token comment">//2. 指定查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//----------------------------------------------------------</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">prefixQuery</span><span class="token punctuation">(</span><span class="token string">&quot;corpName&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;盒马&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//----------------------------------------------------------</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-3-4-fuzzy查询"><a href="#_6-3-4-fuzzy查询" class="header-anchor">#</a> 6.3.4 fuzzy查询</h5> <blockquote><p>模糊查询，我们输入字符的大概（比如 出现错别字），ES就可以去根据输入的内容大概去匹配一下结果。</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># fuzzy查询
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;fuzzy&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;corpName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;盒马先生&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;prefix_length&quot;</span><span class="token operator">:</span> <span class="token number">2</span>			# 指定前面几个字符是不允许出现错误的
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java代码实现Fuzzy查询</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findByFuzzy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    

    <span class="token comment">//2. 指定查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//----------------------------------------------------------</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">fuzzyQuery</span><span class="token punctuation">(</span><span class="token string">&quot;corpName&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;盒马先生&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prefixLength</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//----------------------------------------------------------</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-3-5-wildcard查询"><a href="#_6-3-5-wildcard查询" class="header-anchor">#</a> 6.3.5 wildcard查询</h5> <blockquote><p>通配查询，和MySQL中的like是一个套路，可以在查询时，在字符串中指定通配符*和占位符？</p> <p>*号匹配多个字符       ?匹配一个字符</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># wildcard 查询
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;wildcard&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;corpName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;中国*&quot;</span>    # 可以使用*和？指定通配符和占位符
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java代码实现Wildcard查询</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findByWildCard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 指定查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//----------------------------------------------------------</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">wildcardQuery</span><span class="token punctuation">(</span><span class="token string">&quot;corpName&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;中国*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//----------------------------------------------------------</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-3-6-range查询"><a href="#_6-3-6-range查询" class="header-anchor">#</a> 6.3.6 range查询</h5> <blockquote><p>范围查询，只针对数值类型，对某一个Field进行大于或者小于的范围指定</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># range 查询
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;fee&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;gt&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token property">&quot;lte&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
         # 可以使用 gt：&gt;      gte：&gt;=     lt：&lt;     lte：&lt;=
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java实现range范围查询</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findByRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    

    <span class="token comment">//2. 指定查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//----------------------------------------------------------</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;fee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//----------------------------------------------------------</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_6-3-7-regexp查询"><a href="#_6-3-7-regexp查询" class="header-anchor">#</a> 6.3.7 regexp查询</h5> <blockquote><p>正则查询，通过你编写的正则表达式去匹配内容。</p> <p><a href="">Ps：prefix，fuzzy，wildcard和regexp查询效率相对比较低，要求效率比较高时，避免去使用</a></p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># regexp 查询
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;regexp&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;mobile&quot;</span><span class="token operator">:</span> <span class="token string">&quot;180[0-9]{8}&quot;</span>    # 编写正则
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java代码实现正则查询</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findByRegexp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 指定查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//----------------------------------------------------------</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">regexpQuery</span><span class="token punctuation">(</span><span class="token string">&quot;mobile&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;139[0-9]{8}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//----------------------------------------------------------</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-4-深分页scroll"><a href="#_6-4-深分页scroll" class="header-anchor">#</a> 6.4 深分页Scroll</h4> <blockquote><p>ES对from + size是有限制的，from和size二者之和不能超过1W</p> <p>原理：</p> <ul><li><p>from+size在ES查询数据的方式：</p> <ul><li>第一步现将用户指定的关键进行分词。</li> <li>第二步将词汇去分词库中进行检索，得到多个文档的id。</li> <li>第三步去各个分片中去拉取指定的全部数据。耗时较长。</li> <li>第四步将数据根据score进行排序。耗时较长。</li> <li>第五步根据from的值，将查询到的数据舍弃一部分。</li> <li>第六步返回结果。</li></ul></li> <li><p>scroll+size在ES查询数据的方式：</p> <ul><li>第一步现将用户指定的关键进行分词。</li> <li>第二步将词汇去分词库中进行检索，得到多个文档的id。</li> <li>第三步将文档的id存放在一个ES的上下文中。</li> <li>第四步根据你指定的size的个数去ES中检索指定个数的数据，拿完数据的文档id，会从上下文中移除。</li> <li>第五步如果需要下一页数据，直接去ES的上下文中，找后续内容。</li> <li>第六步循环第四步和第五步</li></ul></li></ul> <p><a href="">Scroll查询方式，不适合做实时的查询</a></p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 执行scroll查询，返回第一页数据，并且将文档id信息存放在ES上下文中，指定生存时间1m
POST /sms-logs-index/sms-logs-type/_search?scroll=1m
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>					# 排序      默认是根据id字段排序
    <span class="token punctuation">{</span>
      <span class="token property">&quot;fee&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>              # 自定义排序字段   也可以指定多个字段排序，比如 fee一样时，按照另一个字段排序
        <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span>    
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

# 根据scroll查询下一页数据
POST /_search/scroll
<span class="token punctuation">{</span>
  <span class="token property">&quot;scroll_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;根据上面第一步得到的scorll_id去指定&gt;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scroll&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;scorll信息的生存时间&gt;&quot;</span>         # 第二次查询 要重新指定上下文存活时间  要不然第二次查询之后  上下文就没了
<span class="token punctuation">}</span>
# 当全部查询完之后 这个 scroll_id 对应的es上下文中的doc id 都被移除干净了


# 删除scroll在ES上下文中的数据
DELETE /_search/scroll/scroll_id
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java实现scroll分页</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scrollQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    

    <span class="token comment">//2. 指定scroll信息</span>
    request<span class="token punctuation">.</span><span class="token function">scroll</span><span class="token punctuation">(</span><span class="token class-name">TimeValue</span><span class="token punctuation">.</span><span class="token function">timeValueMinutes</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 指定查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token string">&quot;fee&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 获取返回结果scrollId，source</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> scrollId <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">getScrollId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;----------首页---------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//5. 循环 - 创建SearchScrollRequest</span>
        <span class="token class-name">SearchScrollRequest</span> scrollRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchScrollRequest</span><span class="token punctuation">(</span>scrollId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//6. 指定scrollId的生存时间</span>
        scrollRequest<span class="token punctuation">.</span><span class="token function">scroll</span><span class="token punctuation">(</span><span class="token class-name">TimeValue</span><span class="token punctuation">.</span><span class="token function">timeValueMinutes</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//7. 执行查询获取返回结果</span>
        <span class="token class-name">SearchResponse</span> scrollResp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">scroll</span><span class="token punctuation">(</span>scrollRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//8. 判断是否查询到了数据，输出</span>
        <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> scrollResp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>hits <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> hits<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;----------下一页---------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">//9. 判断没有查询到数据-退出循环</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;----------结束---------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">//10. 创建CLearScrollRequest</span>
    <span class="token class-name">ClearScrollRequest</span> clearScrollRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClearScrollRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//11. 指定ScrollId</span>
    clearScrollRequest<span class="token punctuation">.</span><span class="token function">addScrollId</span><span class="token punctuation">(</span>scrollId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//12. 删除ScrollId</span>
    <span class="token class-name">ClearScrollResponse</span> clearScrollResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">clearScroll</span><span class="token punctuation">(</span>clearScrollRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//13. 输出结果</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;删除scroll：&quot;</span> <span class="token operator">+</span> clearScrollResponse<span class="token punctuation">.</span><span class="token function">isSucceeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-5-delete-by-query"><a href="#_6-5-delete-by-query" class="header-anchor">#</a> 6.5 delete-by-query</h4> <blockquote><p>根据term，match等查询方式去删除大量的文档</p> <p><a href="">Ps：如果你需要删除的内容，是index下的大部分数据，推荐创建一个全新的index，将保留的文档内容，添加到全新的索引</a></p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># delete-by-query
POST /sms-logs-index/sms-logs-type/_delete_by_query
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;fee&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;lt&quot;</span><span class="token operator">:</span> <span class="token number">4</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java代码实现</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteByQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建DeleteByQueryRequest</span>
    <span class="token class-name">DeleteByQueryRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteByQueryRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//2. 指定检索的条件    和SearchRequest指定Query的方式不一样</span>
    request<span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;fee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行删除</span>
    <span class="token class-name">BulkByScrollResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">deleteByQuery</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出返回结果</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-6-复合查询"><a href="#_6-6-复合查询" class="header-anchor">#</a> 6.6 复合查询</h4> <h5 id="_6-6-1-bool查询"><a href="#_6-6-1-bool查询" class="header-anchor">#</a> 6.6.1 bool查询</h5> <blockquote><p>复合过滤器，将你的多个查询条件，以一定的逻辑组合在一起。</p> <ul><li>must： 所有的条件，用must组合在一起，表示And的意思</li> <li>must_not：将must_not中的条件，全部都不能匹配，标识Not的意思</li> <li>should：所有的条件，用should组合在一起，表示Or的意思</li></ul></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 查询省份为武汉或者北京
# 运营商不是联通
# smsContent中包含中国和平安
# bool查询
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;should&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;province&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;北京&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;province&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;武汉&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;must_not&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;operatorId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;smsContent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;中国&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;smsContent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;平安&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java代码实现Bool查询</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">BoolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">//2. 指定查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// # 查询省份为武汉或者北京</span>
    boolQuery<span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;province&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;武汉&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boolQuery<span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;province&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;北京&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// # 运营商不是联通</span>
    boolQuery<span class="token punctuation">.</span><span class="token function">mustNot</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;operatorId&quot;</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// # smsContent中包含中国和平安</span>
    boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;smsContent&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;中国&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;smsContent&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;平安&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行查询</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-6-2-boosting查询"><a href="#_6-6-2-boosting查询" class="header-anchor">#</a> 6.6.2 boosting查询</h5> <blockquote><p>boosting查询可以帮助我们去影响查询后的score。</p> <ul><li>positive：只有匹配上positive的查询的内容，才会被放到返回的结果集中。</li> <li>negative：如果匹配上和positive并且也匹配上了negative，就可以降低这样的文档score。</li> <li>negative_boost：指定系数，必须小于1.0</li></ul> <p>关于查询时，分数是如何计算的：</p> <ul><li>搜索的关键字在文档中出现的频次越高，分数就越高</li> <li>指定的文档内容越短，分数就越高</li> <li>我们在搜索时，指定的关键字也会被分词，这个被分词的内容，被分词库匹配的个数越多，分数越高</li></ul></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># boosting查询  收货安装
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;boosting&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;positive&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;smsContent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;收货安装&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;negative&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;smsContent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;王五&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;negative_boost&quot;</span><span class="token operator">:</span> <span class="token number">0.5</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java实现Boosting查询</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">BoostingQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 指定查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BoostingQueryBuilder</span> boostingQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boostingQuery</span><span class="token punctuation">(</span>
            <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;smsContent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;收货安装&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;smsContent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;王五&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">negativeBoost</span><span class="token punctuation">(</span><span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boostingQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行查询</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-7-filter查询"><a href="#_6-7-filter查询" class="header-anchor">#</a> 6.7 filter查询</h4> <blockquote><p>query，根据你的查询条件，去计算文档的匹配度得到一个分数，并且根据分数进行排序，不会做缓存的。</p> <p>filter，根据你的查询条件去查询文档，不去计算分数，而且filter会对经常被过滤的数据进行缓存。</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># filter查询
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;corpName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;盒马鲜生&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;fee&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;lte&quot;</span><span class="token operator">:</span> <span class="token number">4</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java实现filter操作</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 查询条件</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;corpName&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;盒马鲜生&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;fee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行查询</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-8-高亮查询【重点】"><a href="#_6-8-高亮查询【重点】" class="header-anchor">#</a> 6.8 高亮查询【<code>重点</code>】</h4> <blockquote><p>高亮查询就是你用户输入的关键字，以一定的特殊样式展示给用户，让用户知道为什么这个结果被检索出来。</p> <p>高亮展示的数据，本身就是文档中的一个Field，单独将Field以highlight的形式返回给你。</p> <p>ES提供了一个highlight属性，和query同级别的。</p> <ul><li>fragment_size：指定高亮数据展示多少个字符回来。默认100个</li> <li>pre_tags：指定前缀标签，举个栗子&lt; font color=&quot;red&quot; &gt;</li> <li>post_tags：指定后缀标签，举个栗子&lt; /font &gt;</li> <li>fields：指定哪几个Field以高亮形式返回</li></ul></blockquote> <table><thead><tr><th style="text-align:center;">效果图</th></tr></thead> <tbody><tr><td style="text-align:center;"><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201208195749344.png" alt="image-20201208195749344"></td></tr></tbody></table> <blockquote><p>RESTful实现</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># highlight查询
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;smsContent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;盒马&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;highlight&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;smsContent&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;pre_tags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;font color='red'&gt;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;post_tags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;/font&gt;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;fragment_size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java实现高亮查询</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">highLightQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//2. 指定查询条件（高亮）</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2.1 指定查询条件</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;smsContent&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;盒马&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2.2 指定高亮</span>
    <span class="token class-name">HighlightBuilder</span> highlightBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    highlightBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;smsContent&quot;</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;font color='red'&gt;&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/font&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span>highlightBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行查询</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 获取高亮数据，输出</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;smsContent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-9-聚合查询【重点】"><a href="#_6-9-聚合查询【重点】" class="header-anchor">#</a> 6.9 聚合查询【<code>重点</code>】</h4> <blockquote><p>aggregations :提供了从数据中分组和提取数据的能力，最简单的聚合方法大致等于SQL GROUP BY 和 SQL 聚合函数。在ES中可以执行搜索返回hits(命中结果)，并且同时返回聚合结果，把一个响应中所有hits (命中结果)分隔开的能力，这是非常强大且有效的 ，可以执行多个查询和聚合，并且在一次使用中得到各自的返回结果，使用一次简洁和简化的API来避免网络往返。</p> <p>ES的聚合查询和MySQL的聚合查询类似，ES的聚合查询相比MySQL要强大的多，ES提供的统计数据的方式多种多样。</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># ES聚合查询的RESTful语法
POST /index/type/_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;名字（agg）&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>   # 名字 自定义 只会影响返回结果的名字
            <span class="token property">&quot;agg_type&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>    # es 给咱们提供的聚合类型   咱们直接使用即可 
                <span class="token property">&quot;属性&quot;</span><span class="token operator">:</span> <span class="token string">&quot;值&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-9-1-去重计数查询"><a href="#_6-9-1-去重计数查询" class="header-anchor">#</a> 6.9.1 去重计数查询</h5> <blockquote><p>去重计数，即Cardinality，第一步先将返回的文档中的一个指定的field进行去重，统计一共有多少条</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 去重计数查询 北京 上海 武汉 山西
# 这些记录中 一共出现了几个省份
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;cardinality&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;province&quot;</span>     # 按照 field 进行去重
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//  Java代码实现去重计数查询</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 指定使用的聚合查询方式</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token string">&quot;agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;province&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行查询</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 获取返回结果</span>
    <span class="token class-name">Cardinality</span> agg <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> value <span class="token operator">=</span> agg<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-9-2-范围统计"><a href="#_6-9-2-范围统计" class="header-anchor">#</a> 6.9.2 范围统计</h5> <blockquote><p>统计一定范围内出现的文档个数，比如，针对某一个Field的值在 0~100,100~200,200~300之间文档出现的个数分别是多少。</p> <p>范围统计可以针对普通的数值，针对时间类型，针对ip类型都可以做相应的统计。</p> <p>range，date_range，ip_range</p></blockquote> <blockquote><p>数值统计</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 数值方式范围统计
POST /sms-logs-index/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;fee&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;ranges&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;to&quot;</span><span class="token operator">:</span> <span class="token number">5</span>        # 没有等于的效果
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>    # from有包含当前值的意思    有等于的效果 
            <span class="token property">&quot;to&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>时间范围统计</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 时间方式范围统计
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;date_range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;createDate&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yyyy&quot;</span><span class="token punctuation">,</span> 
        <span class="token property">&quot;ranges&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;to&quot;</span><span class="token operator">:</span> <span class="token number">2000</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">2000</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ip统计方式</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># ip方式 范围统计
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;ip_range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ipAddr&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;ranges&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;to&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10.126.2.9&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10.126.2.9&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java实现数值 范围统计</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">range</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
   

    <span class="token comment">//2. 指定使用的聚合查询方式</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//---------------------------------------------</span>
    builder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token string">&quot;agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;fee&quot;</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">addUnboundedTo</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">addRange</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">addUnboundedFrom</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//---------------------------------------------</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行查询</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 获取返回结果</span>
    <span class="token class-name">Range</span> agg <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Range<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> agg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> from <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> <span class="token keyword">to</span> <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> docCount <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getDocCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;key：%s，from：%s，to：%s，docCount：%s&quot;</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>from<span class="token punctuation">,</span><span class="token keyword">to</span><span class="token punctuation">,</span>docCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-9-3-统计聚合查询"><a href="#_6-9-3-统计聚合查询" class="header-anchor">#</a> 6.9.3 统计聚合查询</h5> <blockquote><p>他可以帮你查询指定Field的最大值，最小值，平均值，平方和等</p> <p>使用：extended_stats</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 统计聚合查询
POST /sms-logs-index/sms-logs-type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;extended_stats&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;fee&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>代码实现方式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Java实现统计聚合查询</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">extendedStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 指定使用的聚合查询方式</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//---------------------------------------------</span>
    builder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">extendedStats</span><span class="token punctuation">(</span><span class="token string">&quot;agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;fee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//---------------------------------------------</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行查询</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 获取返回结果</span>
    <span class="token class-name">ExtendedStats</span> agg <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> max <span class="token operator">=</span> agg<span class="token punctuation">.</span><span class="token function">getMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> min <span class="token operator">=</span> agg<span class="token punctuation">.</span><span class="token function">getMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;fee的最大值为：&quot;</span> <span class="token operator">+</span> max <span class="token operator">+</span> <span class="token string">&quot;，最小值为：&quot;</span> <span class="token operator">+</span> min<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>其他的聚合查询方式查看官方文档：https://www.elastic.co/guide/en/elasticsearch/reference/6.5/index.html</p></blockquote> <h4 id="_6-10-地图经纬度搜索"><a href="#_6-10-地图经纬度搜索" class="header-anchor">#</a> 6.10 地图经纬度搜索</h4> <blockquote><p>ES中提供了一个数据类型 geo_point，这个类型就是用来存储经纬度的。</p> <p>创建一个带geo_point类型的索引，并添加测试数据</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># 创建一个索引，指定一个name，locaiton
PUT /map
<span class="token punctuation">{</span>
  <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;number_of_shards&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token property">&quot;number_of_replicas&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;map&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;location&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;geo_point&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


# 添加测试数据
PUT /map/map/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;天安门&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;location&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span> <span class="token number">116.403981</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span> <span class="token number">39.914492</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


PUT /map/map/<span class="token number">2</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;海淀公园&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;location&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span> <span class="token number">116.302509</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span> <span class="token number">39.991152</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT /map/map/<span class="token number">3</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;北京动物园&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;location&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span> <span class="token number">116.343184</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span> <span class="token number">39.947468</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-10-1-es的地图检索方式"><a href="#_6-10-1-es的地图检索方式" class="header-anchor">#</a> 6.10.1 ES的地图检索方式</h5> <table><thead><tr><th>语法</th> <th>说明</th></tr></thead> <tbody><tr><td>geo_distance</td> <td>直线距离检索方式</td></tr> <tr><td>geo_bounding_box</td> <td>以两个点确定一个矩形，获取在矩形内的全部数据</td></tr> <tr><td>geo_polygon</td> <td>以多个点，确定一个多边形，获取多边形内的全部数据</td></tr></tbody></table> <h5 id="_6-10-2-基于restful实现地图检索"><a href="#_6-10-2-基于restful实现地图检索" class="header-anchor">#</a> 6.10.2 基于RESTful实现地图检索</h5> <blockquote><p>geo_distance</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># geo_distance
POST /map/map/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;geo_distance&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;location&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>				# 确定一个点
        <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span> <span class="token number">116.433733</span><span class="token punctuation">,</span>
        <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span> <span class="token number">39.908404</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;distance&quot;</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>			 # 确定半径    默认为   米    ，可以通过  unit 来指定
      <span class="token property">&quot;distance_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;arc&quot;</span>     # 指定形状为圆形
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>geo_bounding_box</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># geo_bounding_box
POST /map/map/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;geo_bounding_box&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;location&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;top_left&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>				# 左上角的坐标点
          <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span> <span class="token number">116.326943</span><span class="token punctuation">,</span>
          <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span> <span class="token number">39.95499</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;bottom_right&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>			 # 右下角的坐标点
          <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span> <span class="token number">116.433446</span><span class="token punctuation">,</span>
          <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span> <span class="token number">39.908737</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>geo_polygon</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code># geo_polygon
POST /map/map/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;geo_polygon&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;location&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;points&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>					# 指定多个点确定一个多边形
          <span class="token punctuation">{</span>
            <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span> <span class="token number">116.298916</span><span class="token punctuation">,</span>
            <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span> <span class="token number">39.99878</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span> <span class="token number">116.29561</span><span class="token punctuation">,</span>
            <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span> <span class="token number">39.972576</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span> <span class="token number">116.327661</span><span class="token punctuation">,</span>
            <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span> <span class="token number">39.984739</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-10-3-java实现geo-polygon"><a href="#_6-10-3-java实现geo-polygon" class="header-anchor">#</a> 6.10.3 Java实现geo_polygon</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 基于Java实现geo_polygon查询</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">geoPolygon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. SearchRequest</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. 指定检索方式</span>
    <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GeoPoint</span><span class="token punctuation">&gt;</span></span> points <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    points<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GeoPoint</span><span class="token punctuation">(</span><span class="token number">39.99878</span><span class="token punctuation">,</span><span class="token number">116.298916</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    points<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GeoPoint</span><span class="token punctuation">(</span><span class="token number">39.972576</span><span class="token punctuation">,</span><span class="token number">116.29561</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    points<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GeoPoint</span><span class="token punctuation">(</span><span class="token number">39.984739</span><span class="token punctuation">,</span><span class="token number">116.327661</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">geoPolygonQuery</span><span class="token punctuation">(</span><span class="token string">&quot;location&quot;</span><span class="token punctuation">,</span>points<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 执行查询</span>
    <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//4. 输出结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="七、-个人学习"><a href="#七、-个人学习" class="header-anchor">#</a> 七、 个人学习</h3> <p>es 官网 <a href="https://www.elastic.co/cn/" target="_blank" rel="noopener noreferrer">开源搜索：Elasticsearch、ELK Stack 和 Kibana 的开发者 | Elastic<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_7-1基本操作"><a href="#_7-1基本操作" class="header-anchor">#</a> 7.1基本操作</h4> <h5 id="_7-1-1-索引一个文档-保存-相当于保存一条记录-使用-put或者post-一般-put-多用来做修改操作"><a href="#_7-1-1-索引一个文档-保存-相当于保存一条记录-使用-put或者post-一般-put-多用来做修改操作" class="header-anchor">#</a> 7.1.1 索引一个文档（保存） 相当于保存一条记录    使用  PUT或者POST ,一般 PUT 多用来做修改操作</h5> <blockquote><p>保存一条记录，保存到那个索引 的 哪个类型下 ，指定用哪个唯一标识        类似   保存一条记录 到哪个数据库下的哪张表下    指定主键id</p> <ol><li>PUT  book/novel/1        在 book 索引 下 的  novel 类型 下  保存 1 号数据为</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>PUT book/novel/1
<span class="token punctuation">{</span>
	<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;大奉打更人&quot;</span>,
	<span class="token string">&quot;author&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;xxx&quot;</span>
<span class="token punctuation">}</span>
第一次发送这个请求     是  添加操作 ，
</code></pre></div></blockquote> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201011162000316.png" alt="image-20201011162000316"></p> <blockquote><p>第一次之后  发送这个请求 是  修改操作       版本号 会变    版本号 是不断叠加的</p></blockquote> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201011173353081.png" alt="image-20201011173353081"></p> <blockquote><ol start="2"><li>使用post  保存一条记录       在 book 索引 下 的  novel 类型 下  保存 2 号数据为</li></ol> <p>POST book/novel/2<br>
{
&quot;name&quot;:&quot;西游记&quot;,
&quot;author&quot;:&quot;xxx&quot;
}</p> <p>第一次  执行 是添加操作 ，之后 就是修改操作，使用POST  可以不指定 id  ， 如果不指定id   会自动生成id</p></blockquote> <p><strong>总结PUT和POST的区别：</strong></p> <p>PUT和POST都可以新增和修改</p> <p>POST 新增，如果不指定id ,会自动生成id. 指定id     第一次是添加操作，之后 是修改操作， 并且 新增版本号</p> <p>PUT  必须指定id  , 由于put 必须指定id , 我们一般用来做修改操作 ，不指定id  会报错。</p> <h5 id="_7-1-2-查询文档-查询一条记录"><a href="#_7-1-2-查询文档-查询一条记录" class="header-anchor">#</a> 7.1.2 查询文档   查询一条记录</h5> <blockquote><p>查询一条记录     查询 哪个索引   哪个类型  下    指定  id  的数据</p> <p>GET book/novel/1</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">{</span>
<span class="token string">&quot;_index&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;book&quot;</span>,      <span class="token comment">#  在哪个索引</span>
<span class="token string">&quot;_type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;novel&quot;</span>,      <span class="token comment">#  在哪个类型下</span>
<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,            <span class="token comment">#   id</span>
<span class="token string">&quot;_version&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,         <span class="token comment">#  版本号</span>
<span class="token string">&quot;_seq_no&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,		  <span class="token comment"># 并发控制字段  每次更新更新都会 + 1 ， 用来做乐观锁  </span>
<span class="token string">&quot;_primary_term&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,    <span class="token comment">#  分片   集群相关</span>
<span class="token string">&quot;found&quot;</span> <span class="token builtin class-name">:</span> true,         <span class="token comment">#   表示  找到了这个数据</span>
<span class="token string">&quot;_source&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>           <span class="token comment">#  数据的内容</span>
<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;大奉打更人&quot;</span>,
<span class="token string">&quot;author&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;xxx&quot;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment"># 使用乐观锁来控制并发修改时   带上参数          ?if_seq_no=6&amp;if_primary_term=2       来进行乐观锁控制</span>
PUT book/novel/1?if_seq_no<span class="token operator">=</span><span class="token number">6</span><span class="token operator">&amp;</span><span class="token assign-left variable">if_primary_term</span><span class="token operator">=</span><span class="token number">2</span>

</code></pre></div></blockquote> <h5 id="_7-1-3-更新文档"><a href="#_7-1-3-更新文档" class="header-anchor">#</a> 7.1.3 更新文档</h5> <div class="language-shell extra-class"><pre class="language-shell"><code>POST book/novel/1/_update      <span class="token comment">#  会检查  原数据  和 本次更新的数据   做对比  如果要更改的数据 和 原数据一致  则  result 为noop  没有								 #  操作 ， 版本号   序列号  都不变化</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;doc&quot;</span>:<span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;大奉打更人4&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>POST book/novel/1            <span class="token comment"># 不会检查 原数据和要更新的数据 是否发生变化       会直接更新版本  和  序列号</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;大奉打更人5&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>PUT book/novel/1             <span class="token comment">#  不对比  直接更新      PUT 不能带 _update</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;大奉打更人6&quot;</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>PUT book/novel/1              
<span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;大奉打更人6&quot;</span>,
    <span class="token string">&quot;publish&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;zz&quot;</span>           <span class="token comment"># 也可以在  更新文档的时候  添加属性</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_7-1-4-删除文档-或-索引"><a href="#_7-1-4-删除文档-或-索引" class="header-anchor">#</a> 7.1.4 删除文档  或 索引</h5> <blockquote><p>DELETE book/novel/3                          删除   book  索引下 的   novel type 下的  id  为3 的   记录</p> <p>DELETE book                                         删除  索引  book       没有提供 直接删除  type 的方法</p></blockquote> <h5 id="_7-1-5-bulk-批量操作"><a href="#_7-1-5-bulk-批量操作" class="header-anchor">#</a> 7.1.5  bulk 批量操作</h5> <blockquote><p>POST book/_bulk</p> <p>{&quot;index&quot;:{&quot;_id&quot;:&quot;5&quot;}}</p> <p>{&quot;name&quot;:&quot;水浒传&quot;}</p> <p>{&quot;index&quot;:{&quot;_id&quot;:&quot;2&quot;}}</p> <p>{&quot;name&quot;:&quot;金瓶梅&quot;}</p> <p>语法格式：</p> <p>{action:{metadata}}\n</p> <p>{request body}\n</p> <p>{action:{metadata}}\n</p> <p>{request body}  \n</p> <p>ex:</p> <p>复杂实例</p> <p>POST /_bulk</p> <p>{&quot;delete&quot;:{&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;}}</p> <p>{&quot;create&quot;:{&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;}}</p> <p>{&quot;title&quot;:&quot;My first blog post&quot;}</p> <p>{&quot;index&quot;:{&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;}}</p> <p>{&quot;title&quot;:&quot;My Second blog post&quot;}</p> <p>{&quot;update&quot;:{&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;}}</p> <p>{&quot;doc&quot;:{&quot;title&quot;:&quot;My update blog post&quot;}}</p></blockquote> <h4 id="_7-2-进阶检索"><a href="#_7-2-进阶检索" class="header-anchor">#</a> 7.2 进阶检索</h4> <h5 id="_7-2-1-searchapi"><a href="#_7-2-1-searchapi" class="header-anchor">#</a> 7.2.1 SearchAPI</h5> <blockquote><p>ES 支持两种基本方式检索</p> <p>方式1  通过使用 REST request URI  发送搜索参数   （uri+ 检索参数）</p> <p>方式2 通过使用 REST request body  来发送他们   （uri + 请求体）</p></blockquote> <h5 id="_7-2-2检索信息"><a href="#_7-2-2检索信息" class="header-anchor">#</a> 7.2.2检索信息</h5> <blockquote><p>一切检索 从_search 开始</p> <p>get bank/_search     检索 bank  下的所有信息     包括  type  和  docs</p> <p>get bank/_search?q=*&amp;sort=account_number:asc    请求参数方式 检索</p> <p>相应结果解释：</p> <p>took 花费的时间</p> <p>time_out  有没有超时</p> <p>_shards 集群情况下 每一个分片  为这个检索 做了什么操作</p> <p>hits: 命中的记录   即查询到的记录</p></blockquote> <h5 id="_7-2-3-query-dsl-基本语法格式"><a href="#_7-2-3-query-dsl-基本语法格式" class="header-anchor">#</a> 7.2.3 query DSL     基本语法格式</h5> <blockquote><p>如下  把请求的参数封装成一个json  , es 提供了一个可以查询json 风格的DSL  domain -specific-language 领域特定语言。该查询语言非常全面</p> <p>https://www.elastic.co/guide/en/elasticsearch/reference/7.x/getting-started-search.html</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>        <span class="token comment">#  查询条件</span>
    <span class="token string">&quot;match_all&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;sort&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>    <span class="token comment">#  排序条件</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;account_number&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;order&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;desc&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><p>语法：</p> <p>{</p> <p>QUERY_NAME:{</p> <div class="language- extra-class"><pre><code>  ARGUMENT:VALUE,

  ARGUMENT:VALUE,......
</code></pre></div><p>}</p> <p>}</p> <p>如果是针对某个字段：</p> <p>{</p> <p>QUERY_NAME:{</p> <div class="language- extra-class"><pre><code>  FIELD_NAME:{

  	ARGUMENT:VALUE,

  	ARGUMENT:VALUE,......
</code></pre></div><p>}</p> <p>}</p> <p>}</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_all&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
  , <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">5</span>,
  <span class="token string">&quot;sort&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;account_number&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;order&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;desc&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment"># query 定义如何查询</span>
<span class="token comment"># match_all  查询类型【代表查询】，es 中可以在query 中组合非常多的查询类型完成复杂查询</span>
<span class="token comment"># 除了query 参数之外  我们也可以传递其他的参数 以改变查询结果， 如 sort  和 size </span>
<span class="token comment"># from  + size  限定 完成分页功能</span>
<span class="token comment"># sort 排序 多字段排序 会在前序字段相等时 后续字段内部排序 否则以前序为准</span>
</code></pre></div><h5 id="_7-2-4-query-dsl-返回部分字段"><a href="#_7-2-4-query-dsl-返回部分字段" class="header-anchor">#</a> 7.2.4 query dsl 返回部分字段</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 查询指定字段 </span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_all&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
  , <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">5</span>,
  <span class="token string">&quot;sort&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;account_number&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;order&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;desc&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  <span class="token string">&quot;_source&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;account_number&quot;</span>,<span class="token string">&quot;age&quot;</span>,<span class="token string">&quot;balance&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_7-2-5-match-匹配查询"><a href="#_7-2-5-match-匹配查询" class="header-anchor">#</a> 7.2.5 match 匹配查询</h5> <blockquote><p>基本类型（非字符串） 精确匹配</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 基本类型（非字符串） 精确匹配</span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;account_number&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;20&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment"># match  返回 account_num=20 的 doc</span>

<span class="token comment"># 全文检索 按照评分进行排序 会对检索条件进行分词匹配</span>
<span class="token comment"># 字符串，多个单词（分词+全文检索）</span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;mill road&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment"># 最终查询出address 中包含mill 或者 road 或者 mill road 的所有记录，并给出相关性得分</span>

</code></pre></div><h5 id="_7-2-6-match-phrase-短语匹配"><a href="#_7-2-6-match-phrase-短语匹配" class="header-anchor">#</a> 7.2.6 match_phrase  短语匹配</h5> <blockquote><p>将需要匹配的值当成一个整体单词 （不分词） 进行检索</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_phrase&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;mill road&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment"># 查出address 中 包含mill road 的所有记录 并给出相关性得分</span>
</code></pre></div><h5 id="_7-2-7-multi-match-多字段匹配"><a href="#_7-2-7-multi-match-多字段匹配" class="header-anchor">#</a> 7.2.7  multi_match 多字段匹配</h5> <blockquote><p>multi_match  多字段匹配   查询多个字段中 包含某个查询条件的 记录</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># match_phrase  多字段匹配</span>

GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;multi_match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;mill movico&quot;</span>,
      <span class="token string">&quot;fields&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;city&quot;</span>,<span class="token string">&quot;address&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># address  或 city  这两个字段 中包含 mill 或 movico  任一个值 都能查出来</span>
</code></pre></div><h5 id="_7-2-8-bool-复合查询"><a href="#_7-2-8-bool-复合查询" class="header-anchor">#</a> 7.2.8  bool  复合查询</h5> <blockquote><p>bool 用来做复合查询：复合语句可以合并任何其他查询语句，包括复合语句，了解这一点是很重要的。这就意味着复合语句之间可以互相嵌套，可以表达非常复杂的逻辑</p> <p>1.must : 必须达到must 列举的所有条件</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;bool&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;must&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;mill&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;gender&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;M&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>,
      <span class="token string">&quot;must_not&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;18&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>,
      <span class="token string">&quot;should&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;lastname&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Wallace&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment"># 查出 address 必须匹配 mill  gender 必须匹配M 的 记录</span>
</code></pre></div><blockquote><p>must 必须满足的查询条件   must_not  必须不满足的查询条件     should  最好满足的查询条件 满足了  score 就高 ，不满足    也能查出来</p> <p>如果query 中只有should 且只有一种匹配规则，那么should 的条件就会被作为默认的匹配条件而去改变查询结果。</p> <p>filter 结果过滤</p> <p>并不是所有的查询 都需要产生分数  特别是那些仅用于（filtering）过滤的文档,为了不计算分数  es  会自动检查场景，并且优化查询的执行</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;bool&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;must&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;mill&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>,
      <span class="token string">&quot;filter&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;range&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;balance&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;gte&quot;</span><span class="token builtin class-name">:</span> <span class="token number">10000</span>,
            <span class="token string">&quot;lte&quot;</span><span class="token builtin class-name">:</span> <span class="token number">20000</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># filter 也是 过滤查询  只不过  不计算相关性得分 </span>
</code></pre></div><blockquote><p>term   和match 一样  匹配某个属性的值 ，全文检索字段用match ,其他非text 字段匹配用term</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">28</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">28</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
精确字段 非文本字段 建议使用 term  全匹配    , 文本字段 不建议   使用term  建议使用  match
</code></pre></div><blockquote><p>实现精确查找的  match_phrase  和   keyword 的区别  是       keyword 是和某个字段完全匹配，   match_phrase 是短语匹配 可以是某个字段的一部分</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address.keyword&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;789 Madison Street&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment"># 对比 match_phrase</span>

GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_phrase&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Madison Street&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上 是  es 的  检索  功能</p> <p>下面  来看下 es 的 分析功能</p> <h4 id="_7-3-分析功能"><a href="#_7-3-分析功能" class="header-anchor">#</a> 7.3 分析功能</h4> <blockquote><p>aggregations  执行聚合</p> <p>聚合提供了从数据中分组和提取数据的能力。最简单的聚合方法大致等于SQL GROUP  BY 和 SQL 聚合函数。在ES 中，你有执行搜索返回hits(命中结果)，并且同时返回聚合结果，把一个响应中的所有hits (命中结果)分隔开的能力。这是非常强大且有效的，你可以执行查询和多个聚合，并且在一次使用中得到各自的（任何一个的）返回结果，使用一次简洁和简化的API来避免网络往返。</p></blockquote> <h5 id="_7-3-1搜索address-中-包含mill-的所有人的年龄分布以及平均年龄-但不显示这些人的详情"><a href="#_7-3-1搜索address-中-包含mill-的所有人的年龄分布以及平均年龄-但不显示这些人的详情" class="header-anchor">#</a> 7.3.1搜索address 中 包含mill 的所有人的年龄分布以及平均年龄，但不显示这些人的详情</h5> <div class="language-shell extra-class"><pre class="language-shell"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>    <span class="token comment"># 执行检索</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>  <span class="token comment">#  match  匹配</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;mill&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;aggs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>        <span class="token comment">#  执行聚合</span>
    <span class="token string">&quot;ageAgg&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>    <span class="token comment"># 聚合的名字 方便展示在结果集中</span>
      <span class="token string">&quot;terms&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>   <span class="token comment"># 聚合的类型    查询这个  age 字段的值 有几种    即 年龄分布值</span>
        <span class="token string">&quot;field&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;age&quot;</span>,      <span class="token comment">#  聚合分析的字段</span>
        <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">10</span>         <span class="token comment">#    取几个值</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;ageAvg&quot;</span>:<span class="token punctuation">{</span>    <span class="token comment">#  聚合的名字    平均年龄   起名    ageAvg</span>
      <span class="token string">&quot;avg&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>    <span class="token comment">#  计算  平均值</span>
        <span class="token string">&quot;field&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;balanceAvg&quot;</span>:<span class="token punctuation">{</span>       <span class="token comment"># 聚合的名字 方便展示在结果集中</span>
      <span class="token string">&quot;avg&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>			 <span class="token comment"># 聚合的类型</span>
        <span class="token string">&quot;field&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;balance&quot;</span>      <span class="token comment">#  聚合分析的字段</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>             <span class="token comment"># 不显示搜索的数据</span>
<span class="token punctuation">}</span>
</code></pre></div><p>语法说明：</p> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201018121916610.png" alt="image-20201018121916610"></p> <h5 id="_7-3-2复杂一点的案例1"><a href="#_7-3-2复杂一点的案例1" class="header-anchor">#</a> 7.3.2复杂一点的案例1：</h5> <blockquote><p>按照年龄聚合 ，并且请求这些年龄段的这些人的平均薪资</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 按照年龄聚合 ，并且请求这些年龄段的这些人的平均薪资</span>

GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_all&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;aggs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;ageAgg&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;terms&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;age&quot;</span>,
        <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">100</span>
      <span class="token punctuation">}</span>,
      <span class="token string">&quot;aggs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;balanceAvgByAge&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;avg&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;field&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;balance&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201018124717577.png" alt="image-20201018124717577"></p> <h5 id="_7-3-2复杂一点的案例2"><a href="#_7-3-2复杂一点的案例2" class="header-anchor">#</a> 7.3.2复杂一点的案例2：</h5> <blockquote><p>查出所有年龄分布，并且这些年龄段中性别为M的平均薪资和性别为F的平均薪资 以及这个年龄段的总体平均薪资</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_all&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;aggs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;ageAgg&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;terms&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;age&quot;</span>,
        <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">100</span>
      <span class="token punctuation">}</span>,
      <span class="token string">&quot;aggs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;genderAgg&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;terms&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;field&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;gender.keyword&quot;</span>
            
          <span class="token punctuation">}</span>,
          <span class="token string">&quot;aggs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;avgBalanceByGender&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;avg&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;field&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;balance&quot;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;avgBalanceByAge&quot;</span>:<span class="token punctuation">{</span>
          <span class="token string">&quot;avg&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;field&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;balance&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201018135414635.png" alt="image-20201018135414635"></p> <h4 id="_7-4-映射-mapping"><a href="#_7-4-映射-mapping" class="header-anchor">#</a> 7.4 映射  Mapping</h4> <blockquote><p>https://www.elastic.co/guide/en/elasticsearch/reference/7.x/mapping.html</p> <p>Mapping 定义一个文档如何来被进行处理的  ，定义属性字段时如何被存储和被检索的，比如   使用 mapping 可以定义哪一个String 类型的字段属性应该被当做全文检索的字段，哪个字段属性 应该包含 数值 或者 日期 或者 地理位置坐标 值， 类似 mysql 创建表时  定义每个属性字段的数据类型。在es 中指的就是映射， ES 中有很多数据类型。es 在第一次保存数据时 会自动猜测数据的类型</p></blockquote> <blockquote><p>查看某个索引的映射情况</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>get bank/_mapping        <span class="token comment"># ?  es7 为什么取出了type 的概念，因为es 底层是lucene ，对不同type 下相同的属性处理方式是一样的，如果有两个不同的type,却有相同的 属性 就必须在不同的type 下定义相同的的field 映射，否则 不同type下的相同field 就会在处理中出现冲突的情况 导致lucene处理效率 下降 去掉type 就是为了提高ES处理数据的效率，ES 8 版本 就不支持 type 了，在es 7 版本只是警告</span>
</code></pre></div><p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201018224428680.png" alt="image-20201018224428680"></p> <blockquote><p>es 默认猜测数据类型映射</p> <p>JSON type                                          域type</p> <p>布尔类型：true或者false                   boolean</p> <p>整数： 123											long</p> <p>浮点数：3.14 										double</p> <p>字符串，有效日期：2020-11-11          date</p> <p>字符串：hello  										string</p></blockquote> <blockquote><p>创建索引    并指明映射规则</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>PUT /my_index     <span class="token comment"># 使用 put  创建索引 </span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;mappings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>    <span class="token comment">#  mappings  指定映射规则</span>
    <span class="token string">&quot;properties&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;age&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;integer&quot;</span><span class="token punctuation">}</span>,
      <span class="token string">&quot;email&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;keyword&quot;</span><span class="token punctuation">}</span>,       <span class="token comment">#   keyword   精确匹配</span>
      <span class="token string">&quot;name&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">}</span>      <span class="token comment">#  text  全文匹配</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>添加新的字段映射</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 添加新的字段映射</span>
<span class="token comment"># 字段 参数  index:false  表示当前字段不参与检索    默认为true</span>
PUT /my_index/_mapping
<span class="token punctuation">{</span>
  <span class="token string">&quot;properties&quot;</span>:<span class="token punctuation">{</span>
    <span class="token string">&quot;employee-id&quot;</span>:<span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;keyword&quot;</span>,
      <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;false&quot;</span>        
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>更新映射    对于已经存在的映射 我们不能更新，因为更改已经存在的映射就会改动之前的检索规则，也就是会牵一发动全身 还不如删除了重建。所以   要 更新映射  ， 必须创建新的索引  然后进行数据迁移</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 创建新的索引   属性 要和 旧索引 的属性名字一致</span>
<span class="token comment"># 创建新的索引</span>
PUT /newbank
<span class="token punctuation">{</span>
  <span class="token string">&quot;mappings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;properties&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;account_number&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;address&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;integer&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;balance&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;city&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;email&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
          
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;employer&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
          
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;firstname&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;gender&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;lastname&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>,
          <span class="token string">&quot;fields&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;keyword&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>,
              <span class="token string">&quot;ignore_above&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">256</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 查看创建的新的索引的映射</span>
GET newbank/_mapping

<span class="token comment"># 把旧的索引中的数据 迁移到新的索引</span>
<span class="token comment"># 如果旧的索引  有 type 需要指定 type</span>
POST _reindex     <span class="token comment"># 数据迁移</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;source&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;bank&quot;</span>,
    <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;account&quot;</span>    
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;dest&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;newbank&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 查看 迁移之后的新的索引中的数据</span>
GET newbank/_search

<span class="token comment">#数据迁移语法：</span>
POST _reindes
<span class="token punctuation">{</span>
	<span class="token string">&quot;source&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
		<span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;oldindex&quot;</span>,
		<span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;oldtype&quot;</span>,     <span class="token comment"># 如果有type 需要指定type </span>
	<span class="token punctuation">}</span>,
	<span class="token string">&quot;dest&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
		<span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;newindex&quot;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_7-5ik分词器测试"><a href="#_7-5ik分词器测试" class="header-anchor">#</a> 7.5ik分词器测试</h4> <blockquote><p>安装完ik分词器后测试</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>POST _analyze
<span class="token punctuation">{</span>
  <span class="token string">&quot;analyzer&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ik_smart&quot;</span>,
  <span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;我是中国人&quot;</span>
<span class="token punctuation">}</span>


POST _analyze
<span class="token punctuation">{</span>
  <span class="token string">&quot;analyzer&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;standard&quot;</span>,
  <span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;我是中国人&quot;</span>
<span class="token punctuation">}</span>



POST _analyze
<span class="token punctuation">{</span>
  <span class="token string">&quot;analyzer&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ik_max_word&quot;</span>,
  <span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;我是中国人&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment"># 使用ik分词器 还有个问题   就是一些新词  分词器不能识别  别入一些网络流行语 等 ，所以 咱们可以自定义词库，扩展词库  也比较容易实现，我们可以修改ik分词器的配置文件，让ik 分词器向远程发送请求，要到一些新词，这样 一些新词 就能作为新的词源 进行分解</span>
<span class="token comment">#实现步骤如下</span>
<span class="token comment">#修改/usr/share/elasticsearch/plugins/config 中的IKAnalyzer.cfg.xml</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>﻿<span class="token operator">&lt;</span>?xml <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">&quot;1.0&quot;</span> <span class="token assign-left variable">encoding</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span>?<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE properties SYSTEM <span class="token string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>properties<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>comment<span class="token operator">&gt;</span>IK Analyzer 扩展配置<span class="token operator">&lt;</span>/comment<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">!</span>--用户可以在这里配置自己的扩展字典 --<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>entry <span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token string">&quot;ext_dict&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>/entry<span class="token operator">&gt;</span>
	 <span class="token operator">&lt;</span><span class="token operator">!</span>--用户可以在这里配置自己的扩展停止词字典--<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>entry <span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token string">&quot;ext_stopwords&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>/entry<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">!</span>--用户可以在这里配置远程扩展字典 --<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>entry <span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token string">&quot;remote_ext_dict&quot;</span><span class="token operator">&gt;</span>http://192.168.5.205/fenci/myword.txt<span class="token operator">&lt;</span>/entry<span class="token operator">&gt;</span> 
	<span class="token operator">&lt;</span><span class="token operator">!</span>--用户可以在这里配置远程扩展停止词字典--<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">!</span>-- <span class="token operator">&lt;</span>entry <span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token string">&quot;remote_ext_stopwords&quot;</span><span class="token operator">&gt;</span>words_location<span class="token operator">&lt;</span>/entry<span class="token operator">&gt;</span> --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/properties<span class="token operator">&gt;</span>

</code></pre></div><blockquote><p>定义一个远程请求  让ik 分词器请求这个远程扩展字典 获取最新的分词 我们有两种方式  第一种 自己写个项目 让ik 分词器向这个项目发送请求  处理这个远程请求 返回新的分词  第二种 装上nginx  把最新词库放在nginx 中  让ik 分词器向nginx 发送请求	 让nginx 返回最新词库</p></blockquote> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201023213811238.png" alt="image-20201023213811238"></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">80</span>:80 <span class="token parameter variable">--name</span> nginx <span class="token parameter variable">-d</span> nginx:1.10

<span class="token function">docker</span> container <span class="token function">cp</span> nginx:/etc/nginx <span class="token builtin class-name">.</span> 

<span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">80</span>:80 <span class="token parameter variable">--name</span> nginx <span class="token parameter variable">-v</span> /mydata/nginx/html:/usr/share/nginx/html <span class="token parameter variable">-v</span> /mydata/nginx/logs:/var/log/nginx <span class="token parameter variable">-v</span> /mydata/nginx/conf:/etc/nginx <span class="token parameter variable">-d</span> nginx:1.10

启动之后  会看到 nginx 文件夹下面 有三个文件夹 conf html logs 
在 html 文件夹下 新建  index.html    测试 访问 http://192.168.5.205/   默认 <span class="token number">80</span> 端口 直接能访问到
创建http://192.168.5.205/fenci/myword.txt      继续在这个html 目录下 创建  fenci 文件夹，在这个文件夹内创建  myword.txt ，这个文件中写入新词 高君阳 ，重启  es    ,就能看到效果
</code></pre></div><p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201023214120616.png" alt="image-20201023214120616"></p> <h4 id="_7-6-java-操作es"><a href="#_7-6-java-操作es" class="header-anchor">#</a> 7.6 java 操作es</h4> <blockquote><ol><li><p>9300 端口   走TCP 协议      不建议使用    transport-api.jar    springboot 与 es  需要适配版本</p></li> <li><p>9200 端口  走 http 协议</p></li></ol> <p>解决方案： JestClient   非官方 更新慢</p> <div class="language- extra-class"><pre><code>  				RestTemplate   : 模拟发送http 请求  es 很多操作需要自己封装 麻烦

  				HttpClient 同上

  				Elasticsearch-Rest-Client : 官方RestClient  封装了ES 操作 ，API 层次分明  上手简单
</code></pre></div><p>所以 最终选择       Elasticsearch-Rest-Client</p> <p>为什么不在前端直接发送请求操作es?</p> <ol><li>不对外暴露9200 端口，为了安全</li> <li>js 直接发送请求到 es   , api 支持度低      ，使用java  很多方法都封装好了  方便</li></ol></blockquote> <h5 id="_7-6-1springboot-整合elasticsearch"><a href="#_7-6-1springboot-整合elasticsearch" class="header-anchor">#</a> 7.6.1springboot 整合elasticsearch</h5> <blockquote><p>1.添加依赖</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span><span class="token operator">!</span>--导入 es  的 高阶 api  来 操作 es
     要进行配置
     如果使用spsringdata 操作es  配置会比较简单 只需要在配置文件指定es 的地址就好了
     我们是自己配的 所以自己对es 做配置
 --<span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.elasticsearch.client<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>elasticsearch-rest-high-level-client<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">7.4</span>.<span class="token operator"><span class="token file-descriptor important">2</span>&lt;</span>/version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
引入这个依赖后 发现 elasticsearch 的版本是6.8.7 ,这是因为 springboot 对es 的默认支持  如下
</code></pre></div></blockquote> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201025101510446.png" alt="image-20201025101510446"></p> <blockquote><p>所以 咱们需要手动把这个版本改了       在  搜索模块中 直接指定es 的 版本，把父工程中的版本号覆盖掉</p></blockquote> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20201025101626675.png" alt="image-20201025101626675"></p> <blockquote><p>2.编写配置   给容器注入   RestHighLevelClient</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 创建配置类</span>
@Configuration
public class GlscElasticSearchConfig <span class="token punctuation">{</span>
	   
       
       //RequestOptions   这个类 主要封装了 访问 ES 的  一些头信息   一些 设置信息
    public static final RequestOptions COMMON_OPTIONS<span class="token punctuation">;</span>
    static <span class="token punctuation">{</span>
        // 请求设置项
        RequestOptions.Builder builder <span class="token operator">=</span> RequestOptions.DEFAULT.toBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

//        builder.addHeader<span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span>,<span class="token string">&quot;Bearer&quot;</span>+TOKEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
//        builder.setHttpAsyncResponseConsumerFactory<span class="token punctuation">(</span>new HttpAsyncResponseConsumerFactory
//                .HeapBufferedResponseConsumerFactory<span class="token punctuation">(</span><span class="token number">30</span>*1024*1024*1024<span class="token punctuation">))</span><span class="token punctuation">;</span>

        COMMON_OPTIONS <span class="token operator">=</span> builder.build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
	
    @Bean
    public RestHighLevelClient <span class="token function-name function">esRestClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        RestClientBuilder builder <span class="token operator">=</span> null<span class="token punctuation">;</span>

        builder <span class="token operator">=</span> RestClient.builder<span class="token punctuation">(</span>new HttpHost<span class="token punctuation">(</span><span class="token string">&quot;192.168.56.10&quot;</span>,9200,<span class="token string">&quot;http&quot;</span><span class="token punctuation">))</span><span class="token punctuation">;</span>

        RestHighLevelClient client <span class="token operator">=</span> new RestHighLevelClient<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        //RestHighLevelClient client <span class="token operator">=</span> new RestHighLevelClient<span class="token punctuation">(</span>RestClient.builder<span class="token punctuation">(</span>new HttpHost<span class="token punctuation">(</span><span class="token string">&quot;192.168.56.10&quot;</span>, <span class="token number">9200</span>, <span class="token string">&quot;http&quot;</span><span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token builtin class-name">return</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment"># 测试  获取RestHighLevelClient 这个bean</span>
@SpringBootTest
public class GlscSearchApplicationTests <span class="token punctuation">{</span>

    @Resource
    private RestHighLevelClient client<span class="token punctuation">;</span>
    
    @Test
    public void <span class="token function-name function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System.out.println<span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>    
</code></pre></div><h5 id="_7-6-2-测试保存"><a href="#_7-6-2-测试保存" class="header-anchor">#</a> 7.6.2 测试保存</h5> <blockquote><p>参考 https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-document-index.html</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code> /**
     * 测试存储数据到es
     *
     * 如果没内容  就是添加  有内容 就是更新操作
     * */
    @Test
    public void indexData<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>
        // <span class="token function">users</span>  是 索引 名字
        IndexRequest indexRequest <span class="token operator">=</span> new IndexRequest<span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        indexRequest.id<span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  // 数据的id

        // 第一种方式
        //indexRequest.source<span class="token punctuation">(</span><span class="token string">&quot;userName&quot;</span>,<span class="token string">&quot;zhangsan&quot;</span>,<span class="token string">&quot;age&quot;</span>,18,<span class="token string">&quot;gender&quot;</span>,<span class="token string">&quot;男&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        // 第二种方式    推荐
        User user <span class="token operator">=</span> new User<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user.setUserName<span class="token punctuation">(</span><span class="token string">&quot;lisi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user.setAge<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user.setGender<span class="token punctuation">(</span><span class="token string">&quot;男&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String s <span class="token operator">=</span> JSON.toJSONString<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        indexRequest.source<span class="token punctuation">(</span>s, XContentType.JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>

        // 网络操作 都会有异常
        // 执行保存操作   返回响应
        IndexResponse index <span class="token operator">=</span> client.index<span class="token punctuation">(</span>indexRequest, GlscElasticSearchConfig.COMMON_OPTIONS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        //输出响应
        System.out.println<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h5 id="_7-6-3-测试检索"><a href="#_7-6-3-测试检索" class="header-anchor">#</a> 7.6.3 测试检索</h5> <blockquote><p>参考 https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-search.html</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>/**
     * 测试复杂检索
     *
     * */
    @Test
    public void searchData<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>
        //1.创建检索请求
        SearchRequest searchRequest <span class="token operator">=</span> new SearchRequest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        //2. 指定从哪里开始检索   指定索引
        searchRequest.indices<span class="token punctuation">(</span><span class="token string">&quot;bank&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        //3.指定 DSL  检索条件
        SearchSourceBuilder builder <span class="token operator">=</span> new SearchSourceBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        //3.1 构造检索条件
//        builder.query<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
//        builder.from<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
//        builder.size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
//        builder.aggregation<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder.query<span class="token punctuation">(</span>QueryBuilders.matchQuery<span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span>,<span class="token string">&quot;mill&quot;</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        // 按照年龄的值分布 进行聚合
        TermsAggregationBuilder ageAgg <span class="token operator">=</span> AggregationBuilders.terms<span class="token punctuation">(</span><span class="token string">&quot;ageAgg&quot;</span><span class="token punctuation">)</span>.field<span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span>.size<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder.aggregation<span class="token punctuation">(</span>ageAgg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        // 按照平均薪资 聚合
        AvgAggregationBuilder balanceAvg <span class="token operator">=</span> AggregationBuilders.avg<span class="token punctuation">(</span><span class="token string">&quot;balanceAvg&quot;</span><span class="token punctuation">)</span>.field<span class="token punctuation">(</span><span class="token string">&quot;balance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder.aggregation<span class="token punctuation">(</span>balanceAvg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        // 检索条件
        System.out.println<span class="token punctuation">(</span><span class="token string">&quot;检索条件&quot;</span>+builder.toString<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>

        searchRequest.source<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>


        //4. 执行 检索
        SearchResponse response <span class="token operator">=</span> client.search<span class="token punctuation">(</span>searchRequest, GlscElasticSearchConfig.COMMON_OPTIONS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System.out.println<span class="token punctuation">(</span>response.toString<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>

        //5. 分析结果   结果封装在  response 对象中

        //RestStatus status <span class="token operator">=</span> response.status<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  得到响应状态码
        //TimeValue took <span class="token operator">=</span> response.getTook<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   花费了多长时间
        //boolean timedOut <span class="token operator">=</span> response.isTimedOut<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  是否超时


        // 外层的hits
        SearchHits hits <span class="token operator">=</span> response.getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   // 得到所有命中的记录

        //TotalHits totalHits <span class="token operator">=</span> hits.getTotalHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  // 得到 总记录数
        //long value <span class="token operator">=</span> totalHits.value<span class="token punctuation">;</span>   // 总记录数
        //TotalHits.Relation relation <span class="token operator">=</span> totalHits.relation<span class="token punctuation">;</span>   // 相关性得分

        //float maxScore <span class="token operator">=</span> hits.getMaxScore<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   //最大得分

        // 获取 所有记录  遍历     内层的hits
        SearchHit<span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> hits.getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        for<span class="token punctuation">(</span>SearchHit hit <span class="token builtin class-name">:</span> searchHits<span class="token punctuation">)</span><span class="token punctuation">{</span>
//            String index <span class="token operator">=</span> hit.getIndex<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
//            String <span class="token function">id</span> <span class="token operator">=</span> hit.getId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
//            float score <span class="token operator">=</span> hit.getScore<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
//
//            String sourceAsString <span class="token operator">=</span> hit.getSourceAsString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
//            Map<span class="token operator">&lt;</span>String, Object<span class="token operator">&gt;</span> sourceAsMap <span class="token operator">=</span> hit.getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  // 将返回的数据 转为map

            String sourceAsString <span class="token operator">=</span> hit.getSourceAsString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Account account <span class="token operator">=</span> JSON.parseObject<span class="token punctuation">(</span>sourceAsString, Account.class<span class="token punctuation">)</span><span class="token punctuation">;</span>

            System.out.println<span class="token punctuation">(</span><span class="token string">&quot;account:&quot;</span>+account<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        //获取这次检索到的分析信息
        Aggregations aggregations <span class="token operator">=</span> response.getAggregations<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
//        List<span class="token operator">&lt;</span>Aggregation<span class="token operator">&gt;</span> aggregations1 <span class="token operator">=</span> aggregations.asList<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
//        for<span class="token punctuation">(</span>Aggregation aggregation <span class="token builtin class-name">:</span> aggregations1<span class="token punctuation">)</span><span class="token punctuation">{</span>
//            System.out.println<span class="token punctuation">(</span><span class="token string">&quot;当前聚合的名字：&quot;</span>+aggregation.getName<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
//        <span class="token punctuation">}</span>

        Terms ageAgg1 <span class="token operator">=</span> aggregations.get<span class="token punctuation">(</span><span class="token string">&quot;ageAgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        for<span class="token punctuation">(</span>Terms.Bucket bucket <span class="token builtin class-name">:</span> ageAgg1.getBuckets<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">{</span>
            String keyAsString <span class="token operator">=</span> bucket.getKeyAsString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System.out.println<span class="token punctuation">(</span><span class="token string">&quot;年龄：&quot;</span>+keyAsString<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Avg balanceAvg1 <span class="token operator">=</span> aggregations.get<span class="token punctuation">(</span><span class="token string">&quot;balanceAvg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        System.out.println<span class="token punctuation">(</span><span class="token string">&quot;平均薪资：&quot;</span>+balanceAvg1.getValue<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>

    @Data
    @ToString
    static class Account<span class="token punctuation">{</span>
        private int account_number<span class="token punctuation">;</span>
        private int balance<span class="token punctuation">;</span>
        private String firstname<span class="token punctuation">;</span>
        private String lastname<span class="token punctuation">;</span>
        private int age<span class="token punctuation">;</span>
        private String gender<span class="token punctuation">;</span>
        private String address<span class="token punctuation">;</span>
        private String employer<span class="token punctuation">;</span>
        private String email<span class="token punctuation">;</span>
        private String city<span class="token punctuation">;</span>
        private String state<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


</code></pre></div><h4 id="_7-7-elk-环境安装配置"><a href="#_7-7-elk-环境安装配置" class="header-anchor">#</a> 7.7 elk 环境安装配置</h4> <blockquote><p>拉取logstash镜像</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> pull logstash:7.4.2
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 创建 索引     实际上 这里可以不用创建   直接使用 logstash 添加数据的 时候      创建</span>
PUT /edu_course
<span class="token punctuation">{</span>
  <span class="token string">&quot;settings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;number_of_shards&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
    <span class="token string">&quot;number_of_replicas&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment"># 制定索引的数据接口</span>
POST /edu_course/_mapping
<span class="token punctuation">{</span>
  <span class="token string">&quot;properties&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;description&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;analyzer&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ik_max_word&quot;</span>,
      <span class="token string">&quot;search_analyzer&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ik_smart&quot;</span>,
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;grade&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;mt&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;analyzer&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ik_max_word&quot;</span>,
      <span class="token string">&quot;search_analyzer&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ik_smart&quot;</span>,
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;users&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> false,
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;charge&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;valid&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;pic&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> false,
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;qq&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> false,
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;price&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;float&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;price_old&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;float&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;st&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;studymodel&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;teachmode&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;teachplan&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;analyzer&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ik_max_word&quot;</span>,
      <span class="token string">&quot;search_analyzer&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ik_smart&quot;</span>,
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;expires&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;date&quot;</span>,
      <span class="token string">&quot;format&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;pub_time&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;date&quot;</span>,
      <span class="token string">&quot;format&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;start_time&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;date&quot;</span>,
      <span class="token string">&quot;format&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;end_time&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;date&quot;</span>,
      <span class="token string">&quot;format&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>es 和  kibana 都安装好了 ，并保证 ik 分词器好用</p></blockquote> <blockquote><p>准备logstash 的环境</p></blockquote> <ol><li><p>创建文件件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /opt
<span class="token function">mkdir</span> docker_logstash
<span class="token function">mkdir</span> config
把下面的配置文件准备好  放在config 中
</code></pre></div><p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20210122120518015.png" alt="image-20210122120518015"></p></li></ol> <p>mysql.conf</p> <div class="language-shell extra-class"><pre class="language-shell"><code>input <span class="token punctuation">{</span>
  stdin <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  jdbc <span class="token punctuation">{</span>
  jdbc_connection_string <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;jdbc:mysql://192.168.133.1:3306/edu_course?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=UTC&amp;rewriteBatchedStatements=true&quot;</span>
  <span class="token comment"># the user we wish to excute our statement as</span>
  jdbc_user <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;root&quot;</span>
  jdbc_password <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;123456&quot;</span>
  <span class="token comment"># the path to our downloaded jdbc driver  </span>
  jdbc_driver_library <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;/usr/share/logstash/config/mysql-connector-java-8.0.21.jar&quot;</span> <span class="token comment"># 这里是连接mysql的jar包</span>
  <span class="token comment"># the name of the driver class for mysql</span>
  jdbc_driver_class <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;com.mysql.cj.jdbc.Driver&quot;</span> 
  jdbc_paging_enabled <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;true&quot;</span>
  jdbc_page_size <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;50000&quot;</span>
  <span class="token comment">#要执行的sql文件</span>
  statement <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;select * from course_pub where timestamp &gt; date_add(:sql_last_value,INTERVAL 8 HOUR)&quot;</span>  <span class="token comment"># 执行的sql命令</span>
  <span class="token comment">#定时配置</span>
  schedule <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;* * * * *&quot;</span>
  record_last_run <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
  last_run_metadata_path <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;/usr/share/logstash/config/logstash_metadata&quot;</span> <span class="token comment"># 这里是上次读取时间戳来与数据库查询到的时间戳进行对比，是否向el添加更改数据</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


output <span class="token punctuation">{</span>
  elasticsearch <span class="token punctuation">{</span>
  <span class="token comment">#ES的ip地址和端口</span>
  hosts <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;192.168.133.103:9200&quot;</span>
  <span class="token comment">#hosts =&gt; [&quot;localhost:9200&quot;,&quot;localhost:9202&quot;,&quot;localhost:9203&quot;]</span>
  <span class="token comment">#ES索引库名称</span>
  index <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;edu_course&quot;</span>
  document_id <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;%{id}&quot;</span>
  template <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">&quot;/usr/share/logstash/config/edu_course_template.json&quot;</span>  <span class="token comment"># 这里是索引的模版文件</span>
  template_name <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">&quot;edu_course&quot;</span>
  template_overwrite <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">&quot;true&quot;</span>
  <span class="token punctuation">}</span>
  stdout <span class="token punctuation">{</span>
 <span class="token comment">#日志输出</span>
  codec <span class="token operator">=</span><span class="token operator">&gt;</span> json_lines
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>edu_course_template.json</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
   <span class="token property">&quot;mappings&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      
         <span class="token property">&quot;properties&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;charge&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;description&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
               <span class="token property">&quot;search_analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end_time&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;format&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">,</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;date&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;expires&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;format&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">,</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;date&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;grade&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;id&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;mt&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
               <span class="token property">&quot;search_analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;pic&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;float&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;price_old&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;float&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;pub_time&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;format&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">,</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;date&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;qq&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;st&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start_time&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;format&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">,</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;date&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;studymodel&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;teachmode&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;teachplan&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
               <span class="token property">&quot;search_analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;users&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;valid&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token property">&quot;template&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;edu_course&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">-p</span> <span class="token number">5044</span>:5044 <span class="token parameter variable">-p</span> <span class="token number">9600</span>:9600  <span class="token parameter variable">--name</span> logstash <span class="token parameter variable">-v</span> /opt/docker_logstash/config:/usr/share/logstash/config <span class="token parameter variable">--privileged</span><span class="token operator">=</span>true   logstash:7.4.2 /bin/bash
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /usr/share/logstash/bin
logstash-plugin <span class="token function">install</span> logstash-input-jdbc     <span class="token comment"># 安装这个插件 可能会失败几次</span>

把mysql 的 驱动包放在  /usr/share/logstash/logstash-core/lib/jars      

如果 连接的是 远程的mysql  ,需要开启 mysql 的 远程访问
GRANT ALL PRIVILEGES ON *.* TO <span class="token string">'root'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'123456'</span> WITH GRANT OPTION<span class="token punctuation">;</span>
FLUSH PRIVILEGES

要确保 远程连接本地数据库开启，让别人连接你电脑的本地  数据库  ，测试 是否连通 ，可尝试关闭 本地防火墙。
如果 连接不通 启动 logstash  会报  jdbc 连接 异常    这是一个大坑

还有一个大坑  是  启动时  向es 添加数据 时 的  字段解析异常  特别是 带下划线的  中英文敏感  类似 这个字段pub_time   下划线  问题，  手动删除 这个字段的下划线 ，再手动添加上即可解决问题。  


给logstash_metadata 授权 ，咱们这里 给整个文件夹授权
<span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">777</span> docker_logstash
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /usr/share/logstash/bin
./logstash <span class="token parameter variable">-f</span> <span class="token punctuation">..</span>/config/mysql.conf    <span class="token comment"># 启动logstash 应用  大概率各种报错   注意查看报错信息</span>
</code></pre></div><p><strong>注意   loghstash 日志采集 是连续性的        比如  现在停止 logstash , 那么 下次 logstash 的 采集时间     会接着上次采集的时间点 采集，而不是当前时间  ， 这样的好处 是logstash 能够采集到   时间点连续的数据</strong></p> <p><strong>手把手教你 ：   docker-compose 方式 安装  elk   ,采集mysql 数据库的数据到 es 中</strong></p> <p>参考：<a href="https://blog.csdn.net/weixin_48562791/article/details/124234440" target="_blank" rel="noopener noreferrer">(37条消息) docker-compose部署ELK_内涵i的博客-CSDN博客_docker-compose elk<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>创建目录  :  /opt/docker_compose/docker_elk</p> <p>在这个目录下</p> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20220606171416945.png" alt="image-20220606171416945"></p> <p>创建 docker-compose.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> daocloud.io/library/elasticsearch<span class="token punctuation">:</span>7.4.2  <span class="token comment">#镜像</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> elk_elasticsearch  <span class="token comment">#定义容器名称</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always  <span class="token comment">#开机启动，失败也会一直重启</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;cluster.name=elasticsearch-2201&quot;</span> <span class="token comment">#设置集群名称为elasticsearch</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;discovery.type=single-node&quot;</span> <span class="token comment">#以单一节点模式启动</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx1024m&quot;</span> <span class="token comment">#设置使用jvm内存大小</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /opt/docker_compose/docker_elk/elasticsearch/plugins<span class="token punctuation">:</span>/usr/share/elasticsearch/plugins <span class="token comment">#插件文件挂载</span>
      <span class="token punctuation">-</span> /opt/docker_compose/docker_elk/elasticsearch/data<span class="token punctuation">:</span>/usr/share/elasticsearch/data <span class="token comment">#数据文件挂载</span>
      <span class="token punctuation">-</span> /opt/docker_compose/docker_elk/elasticsearch/config/elasticsearch.yml<span class="token punctuation">:</span>/usr/share/elasticsearch/config/elasticsearch.yml <span class="token comment">#配置文件挂载</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 9200<span class="token punctuation">:</span><span class="token number">9200</span>
      <span class="token punctuation">-</span> 9300<span class="token punctuation">:</span><span class="token number">9300</span>
  <span class="token key atrule">kibana</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> daocloud.io/library/kibana<span class="token punctuation">:</span>7.4.2
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> elk_kibana
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch <span class="token comment">#kibana在elasticsearch启动之后再启动</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ELASTICSEARCH_URL=http<span class="token punctuation">:</span>//elasticsearch<span class="token punctuation">:</span><span class="token number">9200</span> <span class="token comment">#设置访问elasticsearch的地址</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 5601<span class="token punctuation">:</span><span class="token number">5601</span>
  <span class="token key atrule">logstash</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> logstash<span class="token punctuation">:</span>7.4.2
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> elk_logstash
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token comment">#- /opt/docker_compose/docker_elk/logstash/mysql.conf:/usr/share/logstash/pipeline/logstash.conf #挂载logstash的配置文件</span>
      <span class="token punctuation">-</span> /opt/docker_compose/docker_elk/logstash/config<span class="token punctuation">:</span>/usr/share/logstash/config <span class="token comment">#挂载logstash的配置文件</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch <span class="token comment">#kibana在elasticsearch启动之后再启动</span>
    <span class="token key atrule">links</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch<span class="token punctuation">:</span>es <span class="token comment">#可以用es这个域名访问elasticsearch服务</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 4560<span class="token punctuation">:</span><span class="token number">4560</span>


</code></pre></div><p>注意： yml 文件中涉及的所有端口  都在防火墙打开</p> <p>创建elasticsearch目录</p> <div class="language- extra-class"><pre><code>在elasticsearch 目录下创建  es 需要挂载的 容器卷
</code></pre></div><p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20220606171739105.png" alt="image-20220606171739105"></p> <p>config文件夹下创建 elasticsearch.yml    内容如下</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">network.host</span><span class="token punctuation">:</span> 0.0.0.0  <span class="token comment">#使用的网络</span>
<span class="token key atrule">http.cors.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#跨域配置</span>
<span class="token key atrule">http.cors.allow-origin</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
<span class="token comment">#xpack.security.enabled: true  #开启密码配置   </span>


</code></pre></div><p>注意       chmod -R 777 elasticsearch  授权</p> <p>创建logstash 目录</p> <p>在logstash 目录下 创建 logstash 需要挂载的容器卷 config     ,config 内 放的是 logstash 的 配置文件</p> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20220606171948053.png" alt="image-20220606171948053"></p> <p>文件介绍：</p> <p><strong>edu_course_template.json</strong>         会依据这个文件  自动在 es 中创建 指定的索引  ，这个索引的结构 需要和 mysql 表的结构对应</p> <p><strong>mysql.conf</strong>     logstash  的 核心配置文件  ，  配置了  input   指定 数据来自哪里   和  output  指定数据往那里去  ，如果需要改变数据源</p> <p>就 需要 改动这个文件</p> <div class="language-conf extra-class"><pre class="language-text"><code>input {
  stdin {
  }
  jdbc {
  jdbc_connection_string =&gt; &quot;jdbc:mysql://192.168.211.1:3306/edu_course?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=UTC&amp;rewriteBatchedStatements=true&quot;
  # the user we wish to excute our statement as
  jdbc_user =&gt; &quot;java2201&quot;
  jdbc_password =&gt; &quot;123456&quot;
  # the path to our downloaded jdbc driver  
  jdbc_driver_library =&gt; &quot;/usr/share/logstash/config/mysql-connector-java-8.0.21.jar&quot; # 这里是连接mysql的jar包
  # the name of the driver class for mysql
  jdbc_driver_class =&gt; &quot;com.mysql.cj.jdbc.Driver&quot; 
  jdbc_paging_enabled =&gt; &quot;true&quot;
  jdbc_page_size =&gt; &quot;50000&quot;
  #要执行的sql文件
  statement =&gt; &quot;select * from course_pub where timestamp &gt; date_add(:sql_last_value,INTERVAL 8 HOUR)&quot;  # 执行的sql命令
  #定时配置    定时查询上面满足条件的数据   存到es 中
  schedule =&gt; &quot;* * * * *&quot;
  record_last_run =&gt; true
  last_run_metadata_path =&gt; &quot;/usr/share/logstash/config/logstash_metadata&quot; # 这里是上次读取时间戳来与数据库查询到的时间戳进行对比，是否向el添加更改数据
  }
}


output {
  elasticsearch {
  #ES的ip地址和端口
  hosts =&gt; &quot;192.168.211.102:9200&quot;
  #hosts =&gt; [&quot;localhost:9200&quot;,&quot;localhost:9202&quot;,&quot;localhost:9203&quot;]
  #ES索引库名称
  index =&gt; &quot;edu_course&quot;
  document_id =&gt; &quot;%{id}&quot;
  template =&gt;&quot;/usr/share/logstash/config/edu_course_template.json&quot;  # 这里是索引的模版文件
  template_name =&gt;&quot;edu_course&quot;
  template_overwrite =&gt;&quot;true&quot;
  }
  stdout {
 #日志输出
  codec =&gt; json_lines
  }
}

</code></pre></div><p><strong>mysql-connector-java-8.0.21.jar</strong>    mysql 的 驱动  ，这里 需要启动 logstash 容器后 ，进入容器 配置一下</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /usr/share/logstash/bin
logstash-plugin <span class="token function">install</span> logstash-input-jdbc     <span class="token comment"># 安装这个插件 可能会失败几次</span>

把mysql 的 驱动包放在  /usr/share/logstash/logstash-core/lib/jars      

如果 连接的是 远程的mysql  ,需要开启 mysql 的 远程访问
GRANT ALL PRIVILEGES ON *.* TO <span class="token string">'root'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'123456'</span> WITH GRANT OPTION<span class="token punctuation">;</span>
FLUSH PRIVILEGES

要确保 远程连接本地数据库开启，让别人连接你电脑的本地  数据库  ，测试 是否连通 ，可尝试关闭 本地防火墙。
如果 连接不通 启动 logstash  会报  jdbc 连接 异常    这是一个大坑

还有一个大坑  是  启动时  向es 添加数据 时 的  字段解析异常  特别是 带下划线的  中英文敏感  类似 这个字段pub_time   下划线  问题，  手动删除 这个字段的下划线 ，再手动添加上即可解决问题。  




</code></pre></div><p>注意  chmod -R 777  logstash，  这两个目录  递归授权</p> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20220606172722787.png" alt="image-20220606172722787"></p> <p>logstash 配置完之后 ，重启  logstash 容器。</p> <p><strong>pipelines.yml</strong>   这个文件指定了  logstash 启动的时候  读取哪个配置文件</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token punctuation">-</span> <span class="token key atrule">pipeline.id</span><span class="token punctuation">:</span> main    <span class="token comment"># 注意 格式 </span>
  <span class="token key atrule">path.config</span><span class="token punctuation">:</span> <span class="token string">&quot;/usr/share/logstash/config/mysql.conf&quot;</span>    <span class="token comment"># 这个是 启动logstash  读取的配置文件</span>
  <span class="token key atrule">pipeline.workers</span><span class="token punctuation">:</span> <span class="token number">3</span>
</code></pre></div><p>采集的数据库 及  表的结构：</p> <p><img src="https://gllspictures.oss-cn-beijing.aliyuncs.com/img/image-20220606172936977.png" alt="image-20220606172936977"></p> <p>创建数据库及表：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>course_pub<span class="token punctuation">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>course_pub<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'课程名称'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'适用人群'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>mt<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'大分类'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>st<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'小分类'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>grade<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'课程等级'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>studymodel<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'学习模式'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>teachmode<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'教育模式'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>description<span class="token punctuation">`</span></span> <span class="token keyword">text</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'课程介绍'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>timestamp<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'时间戳logstash使用'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>charge<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'收费规则，对应数据字典'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>valid<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'有效性，对应数据字典'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>qq<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'咨询qq'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>price<span class="token punctuation">`</span></span> <span class="token keyword">float</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'价格'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>price_old<span class="token punctuation">`</span></span> <span class="token keyword">float</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'原价格'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>expires<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>start_time<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'课程有效期-开始时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>end_time<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'课程有效期-结束时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>pic<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'课程图片'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>teachplan<span class="token punctuation">`</span></span> <span class="token keyword">text</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'课程计划'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>pub_time<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'发布时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token comment">/*Data for the table `course_pub` */</span>

<span class="token keyword">insert</span>  <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>course_pub<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>mt<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>st<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>grade<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>studymodel<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>teachmode<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>description<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>timestamp<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>charge<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>valid<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>qq<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>price<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>price_old<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>expires<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>start_time<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>end_time<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>pic<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>teachplan<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>pub_time<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'297e7c7c62b8aa9d0162b8accd4c0003'</span><span class="token punctuation">,</span><span class="token string">'java2201'</span><span class="token punctuation">,</span><span class="token string">'java基础4'</span><span class="token punctuation">,</span><span class="token string">'1-3'</span><span class="token punctuation">,</span><span class="token string">'1-3-2'</span><span class="token punctuation">,</span><span class="token string">'200002'</span><span class="token punctuation">,</span><span class="token string">'201001'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'java基础4java基础4java基础4java基础4java基础4java基础4java基础4'</span><span class="token punctuation">,</span><span class="token string">'2022-06-06 16:18:35'</span><span class="token punctuation">,</span><span class="token string">'203001'</span><span class="token punctuation">,</span><span class="token string">'204001'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'group1/M00/00/00/wKiFZ2AJHOeANDrrAAA3Ts5q3pw518.jpg'</span><span class="token punctuation">,</span><span class="token string">'null'</span><span class="token punctuation">,</span><span class="token string">'2021-01-27 09:18:34'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'297e7c7c62b8aa9d0162b8ad78a10004'</span><span class="token punctuation">,</span><span class="token string">'java基础5'</span><span class="token punctuation">,</span><span class="token string">'java基础5'</span><span class="token punctuation">,</span><span class="token string">'1-3'</span><span class="token punctuation">,</span><span class="token string">'1-3-2'</span><span class="token punctuation">,</span><span class="token string">'200001'</span><span class="token punctuation">,</span><span class="token string">'201001'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'12345'</span><span class="token punctuation">,</span><span class="token string">'2021-01-27 08:56:45'</span><span class="token punctuation">,</span><span class="token string">'203001'</span><span class="token punctuation">,</span><span class="token string">'204001'</span><span class="token punctuation">,</span><span class="token string">'123'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'group1/M00/00/00/wKiFZ2ANZ1yAQ2YAAACYhkQQGbo003.jpg'</span><span class="token punctuation">,</span><span class="token string">'{\&quot;children\&quot;:[{\&quot;children\&quot;:[],\&quot;id\&quot;:\&quot;4028058177243f64017724424c820001\&quot;,\&quot;pname\&quot;:\&quot;java异常机制的引入\&quot;}],\&quot;id\&quot;:\&quot;4028058177243f64017724424c820000\&quot;,\&quot;pname\&quot;:\&quot;java基础5\&quot;}'</span><span class="token punctuation">,</span><span class="token string">'2021-01-27 08:56:45'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'40280581771504c70177153076670000'</span><span class="token punctuation">,</span><span class="token string">'vue入门'</span><span class="token punctuation">,</span><span class="token string">'有一定前端基础'</span><span class="token punctuation">,</span><span class="token string">'1-1'</span><span class="token punctuation">,</span><span class="token string">'1-1-9'</span><span class="token punctuation">,</span><span class="token string">'200003'</span><span class="token punctuation">,</span><span class="token string">'201002'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'前后端分离 前端工程'</span><span class="token punctuation">,</span><span class="token string">'2021-09-29 16:10:46'</span><span class="token punctuation">,</span><span class="token string">'203001'</span><span class="token punctuation">,</span><span class="token string">'204001'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'group1/M00/00/00/wKiFZ2ANbZ2AJ7r0AACYhkQQGbo338.jpg'</span><span class="token punctuation">,</span><span class="token string">'null'</span><span class="token punctuation">,</span><span class="token string">'2021-01-26 16:10:46'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'40280581771856a201771871b0760000'</span><span class="token punctuation">,</span><span class="token string">'juc并发包'</span><span class="token punctuation">,</span><span class="token string">'有一定java并发基础的学员'</span><span class="token punctuation">,</span><span class="token string">'1-3'</span><span class="token punctuation">,</span><span class="token string">'1-3-2'</span><span class="token punctuation">,</span><span class="token string">'200003'</span><span class="token punctuation">,</span><span class="token string">'201001'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'xxxx'</span><span class="token punctuation">,</span><span class="token string">'2021-01-26 16:18:35'</span><span class="token punctuation">,</span><span class="token string">'203001'</span><span class="token punctuation">,</span><span class="token string">'204001'</span><span class="token punctuation">,</span><span class="token string">'111'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'group1/M00/00/00/wKiFZ2AI0WuAK7ZcAACYhkQQGbo409.jpg'</span><span class="token punctuation">,</span><span class="token string">'{\&quot;children\&quot;:[{\&quot;children\&quot;:[],\&quot;id\&quot;:\&quot;40288ae5771aa2e001771aac6fe50001\&quot;,\&quot;pname\&quot;:\&quot;1.volitale关键\&quot;}],\&quot;id\&quot;:\&quot;40288ae5771aa2e001771aac6fdd0000\&quot;,\&quot;pname\&quot;:\&quot;juc并发包\&quot;}'</span><span class="token punctuation">,</span><span class="token string">'2021-01-26 16:16:34'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'40281f81640220d601640222665b0001'</span><span class="token punctuation">,</span><span class="token string">'java零基础入门'</span><span class="token punctuation">,</span><span class="token string">'java小白'</span><span class="token punctuation">,</span><span class="token string">'1-3'</span><span class="token punctuation">,</span><span class="token string">'1-3-2'</span><span class="token punctuation">,</span><span class="token string">'200001'</span><span class="token punctuation">,</span><span class="token string">'201001'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'java零基础入门java零基础入门java零基础入门java零基础入门123'</span><span class="token punctuation">,</span><span class="token string">'2021-12-17 15:12:38'</span><span class="token punctuation">,</span><span class="token string">'203001'</span><span class="token punctuation">,</span><span class="token string">'204001'</span><span class="token punctuation">,</span><span class="token string">'xxxx'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'group1/M00/00/00/wKiFZ2ANbdiAOrt2AACYhkQQGbo098.jpg'</span><span class="token punctuation">,</span><span class="token string">'null'</span><span class="token punctuation">,</span><span class="token string">'2021-01-27 08:59:23'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'4028e58161bcf7f40161bcf8b77c0000'</span><span class="token punctuation">,</span><span class="token string">'spring cloud实战'</span><span class="token punctuation">,</span><span class="token string">'所有人'</span><span class="token punctuation">,</span><span class="token string">'1-3'</span><span class="token punctuation">,</span><span class="token string">'1-3-2'</span><span class="token punctuation">,</span><span class="token string">'200003'</span><span class="token punctuation">,</span><span class="token string">'201001'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基础入门 3.实战Spring Boot 4.注册中心eureka。'</span><span class="token punctuation">,</span><span class="token string">'2021-06-10 18:59:01'</span><span class="token punctuation">,</span><span class="token string">'203002'</span><span class="token punctuation">,</span><span class="token string">'204002'</span><span class="token punctuation">,</span><span class="token string">'54354353'</span><span class="token punctuation">,</span><span class="token number">0.01</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'group1/M00/00/00/wKiFZ2ANbjyAcufKAACYhkQQGbo470.jpg'</span><span class="token punctuation">,</span><span class="token string">'{\&quot;children\&quot;:[{\&quot;children\&quot;:[{\&quot;id\&quot;:\&quot;4028e58161bd18ea0161bd1b00ab0000\&quot;,\&quot;pname\&quot;:\&quot;为什么要使用微服务:单体架构的特点\&quot;},{\&quot;id\&quot;:\&quot;4028e58161bd18ea0161bd1bd2d10001\&quot;,\&quot;pname\&quot;:\&quot;为什么要使用微服务:微服务的优缺点\&quot;}],\&quot;id\&quot;:\&quot;4028e58161bd14c20161bd14f1520000\&quot;,\&quot;pname\&quot;:\&quot;微服务架构入门\&quot;},{\&quot;children\&quot;:[{\&quot;id\&quot;:\&quot;4028e58161bd18ea0161bd1d2f3f0005\&quot;,\&quot;pname\&quot;:\&quot;为什么要选择spring cloud?\&quot;},{\&quot;id\&quot;:\&quot;4028e58161bd18ea0161bd1d8f1b0006\&quot;,\&quot;pname\&quot;:\&quot;为什么springcloud要设计一套新的版本升级规则？\&quot;}],\&quot;id\&quot;:\&quot;4028e58161bd18ea0161bd1c83590002\&quot;,\&quot;pname\&quot;:\&quot;spring cloud 基础入门\&quot;},{\&quot;children\&quot;:[{\&quot;id\&quot;:\&quot;4028e58161bd18ea0161bd1df0ad0007\&quot;,\&quot;pname\&quot;:\&quot;为什么越来越多的开发者选择使用spring boot？它解决了什么问题？\&quot;},{\&quot;id\&quot;:\&quot;4028e58161bd18ea0161bd1f73190008\&quot;,\&quot;pname\&quot;:\&quot;spring boot的入门例子\&quot;}],\&quot;id\&quot;:\&quot;4028e58161bd18ea0161bd1cc4850003\&quot;,\&quot;pname\&quot;:\&quot;实战-Spring Boot\&quot;},{\&quot;children\&quot;:[{\&quot;id\&quot;:\&quot;4028e58161bd18ea0161bd1fd31c0009\&quot;,\&quot;pname\&quot;:\&quot;微服务架构为什么需要注册中心，它解决了什么问题？\&quot;},{\&quot;id\&quot;:\&quot;4028e58161bd18ea0161bd202c45000a\&quot;,\&quot;pname\&quot;:\&quot; 一个Eureka注册中心的入门例子\&quot;}],\&quot;id\&quot;:\&quot;4028e58161bd18ea0161bd1cf3e10004\&quot;,\&quot;pname\&quot;:\&quot;注册中心Eureka\&quot;},{\&quot;children\&quot;:[{\&quot;id\&quot;:\&quot;40288ae57705d2ba0177063ef2500001\&quot;,\&quot;pname\&quot;:\&quot;feign的引入\&quot;},{\&quot;id\&quot;:\&quot;40288ae57705d2ba0177063fa3420002\&quot;,\&quot;pname\&quot;:\&quot;如何配置feign\&quot;},{\&quot;id\&quot;:\&quot;40280581771472f0017714745dd10000\&quot;,\&quot;pname\&quot;:\&quot;feign的相关注解\&quot;}],\&quot;id\&quot;:\&quot;40288ae57705d2ba0177063cf5950000\&quot;,\&quot;pname\&quot;:\&quot;feign\&quot;}],\&quot;id\&quot;:\&quot;22\&quot;,\&quot;pname\&quot;:\&quot;spring cloud与spring boot实战\&quot;}'</span><span class="token punctuation">,</span><span class="token string">'2021-01-27 08:59:01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'4028e58161bd3b380161bd3bcd2f0000'</span><span class="token punctuation">,</span><span class="token string">'Redis从入门到项目实战'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">'1-3'</span><span class="token punctuation">,</span><span class="token string">'1-3-2'</span><span class="token punctuation">,</span><span class="token string">'200002'</span><span class="token punctuation">,</span><span class="token string">'201001'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'redis在当前的大型网站和500强企业中，已被广泛应用。 redis是基于内存的key-value数据库，比传统的关系型数据库在性能方面有非常大的优势。 肖老师这套视频，精选了redis在实际项目中的十几个应用场景。通过本课程的学习，可以让学员快速掌握redis在实际项目中如何应用。 作为架构师，redis是必须要掌握的技能！'</span><span class="token punctuation">,</span><span class="token string">'2021-12-17 15:33:48'</span><span class="token punctuation">,</span><span class="token string">'203002'</span><span class="token punctuation">,</span><span class="token string">'204001'</span><span class="token punctuation">,</span><span class="token string">'32432432'</span><span class="token punctuation">,</span><span class="token number">0.01</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'group1/M00/00/00/wKiFZ2ANbcGAI9ArAACYhkQQGbo336.jpg'</span><span class="token punctuation">,</span><span class="token string">'{\&quot;children\&quot;:[{\&quot;children\&quot;:[{\&quot;grade\&quot;:\&quot;3\&quot;,\&quot;id\&quot;:\&quot;4028e58161bd3b380161bd3fe9220008\&quot;,\&quot;mediaFileOriginalName\&quot;:\&quot;1.测试NoSql简介.avi\&quot;,\&quot;mediaId\&quot;:\&quot;320121d2e1cbfc38a56d89abe3569aeb\&quot;,\&quot;pname\&quot;:\&quot;第一节 NoSQL简介\&quot;},{\&quot;grade\&quot;:\&quot;3\&quot;,\&quot;id\&quot;:\&quot;4028e58161bd3b380161bd40cf340009\&quot;,\&quot;mediaFileOriginalName\&quot;:\&quot;2.认识Redis.avi\&quot;,\&quot;mediaId\&quot;:\&quot;734d4a717dc3bae5cefa9315b3be0e7f\&quot;,\&quot;pname\&quot;:\&quot;第二节 认识Redis\&quot;}],\&quot;grade\&quot;:\&quot;2\&quot;,\&quot;id\&quot;:\&quot;4028e58161bd3b380161bd3e47da0003\&quot;,\&quot;pname\&quot;:\&quot;第一章：redis简介\&quot;},{\&quot;children\&quot;:[],\&quot;grade\&quot;:\&quot;2\&quot;,\&quot;id\&quot;:\&quot;4028e58161bd3b380161bd3f484c0004\&quot;,\&quot;pname\&quot;:\&quot;第二章：redis的安装与配置\&quot;},{\&quot;children\&quot;:[],\&quot;grade\&quot;:\&quot;2\&quot;,\&quot;id\&quot;:\&quot;4028e58161bd3b380161bd3f6f440005\&quot;,\&quot;pname\&quot;:\&quot;第三章：Redis数据操作\&quot;},{\&quot;children\&quot;:[],\&quot;grade\&quot;:\&quot;2\&quot;,\&quot;id\&quot;:\&quot;4028e58161bd3b380161bd3fb0050006\&quot;,\&quot;pname\&quot;:\&quot;第四章：Redis进阶操作\&quot;},{\&quot;children\&quot;:[],\&quot;grade\&quot;:\&quot;2\&quot;,\&quot;id\&quot;:\&quot;4028e58161bd3b380161bd3fd3420007\&quot;,\&quot;pname\&quot;:\&quot;第五章：Redis主从配置\&quot;}],\&quot;grade\&quot;:\&quot;1\&quot;,\&quot;id\&quot;:\&quot;4028e58161bd3b380161bd3bcd400001\&quot;,\&quot;pname\&quot;:\&quot;Redis从入门到项目实战\&quot;}'</span><span class="token punctuation">,</span><span class="token string">'2021-06-09 18:33:48'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="八、elasticsearch-环境"><a href="#八、elasticsearch-环境" class="header-anchor">#</a> 八、Elasticsearch 环境</h3> <h4 id="_8-1概念"><a href="#_8-1概念" class="header-anchor">#</a> 8.1概念</h4> <h5 id="_8-1-1单机-集群"><a href="#_8-1-1单机-集群" class="header-anchor">#</a> 8.1.1单机&amp;集群</h5> <p>单台 Elasticsearch 服务器提供服务，往往都有最大的负载能力，超过这个阈值，服务器 性能就会大大降低甚至不可用，所以生产环境中，一般都是运行在指定服务器集群中。</p> <p>除了负载能力，单点服务器也存在其他问题：</p> <ul><li>单台机器存储容量有限</li> <li>单服务器容易出现单点故障，无法实现高可用</li> <li>单服务的并发处理能力有限</li></ul> <p>配置服务器集群时，集群中节点数量没有限制，大于等于 2 个节点就可以看做是集群了。一 般出于高性能及高可用方面来考虑集群中节点数量都是 3 个以上。</p> <p>集群cluster</p> <p>一个集群就是由一个或多个服务器节点组织在一起，共同持有整个的数据，并一起提供 索引和搜索功能。一个 Elasticsearch 集群有一个唯一的名字标识，这个名字默认就 是”elasticsearch”。这个名字是重要的，因为一个节点只能通过指定某个集群的名字，来加入 这个集群。</p> <p>节点 node</p> <p>集群中包含很多服务器，一个节点就是其中的一个服务器。作为集群的一部分，它存储 数据，参与集群的索引和搜索功能。</p> <p>一个节点也是由一个名字来标识的，默认情况下，这个名字是一个随机的漫威漫画角色 的名字，这个名字会在启动的时候赋予节点。这个名字对于管理工作来说挺重要的，因为在 这个管理过程中，你会去确定网络中的哪些服务器对应于 Elasticsearch 集群中的哪些节点。</p> <p>一个节点可以通过配置集群名称的方式来加入一个指定的集群。默认情况下，每个节点 都会被安排加入到一个叫做“elasticsearch”的集群中，这意味着，如果你在你的网络中启动了 若干个节点，并假定它们能够相互发现彼此，它们将会自动地形成并加入到一个叫做 “elasticsearch”的集群中。</p> <p>在一个集群里，只要你想，可以拥有任意多个节点。而且，如果当前你的网络中没有运 行任何 Elasticsearch 节点，这时启动一个节点，会默认创建并加入一个叫做“elasticsearch”的 集群。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-3" data-v-b57cc07c><a href="/java/part4/elasticsearch.html#一、引言" class="sidebar-link reco-side-一、引言" data-v-b57cc07c>一、引言</a></li><li class="level-3" data-v-b57cc07c><a href="/java/part4/elasticsearch.html#二、es概述" class="sidebar-link reco-side-二、es概述" data-v-b57cc07c>二、ES概述</a></li><li class="level-3" data-v-b57cc07c><a href="/java/part4/elasticsearch.html#三、-elasticsearch安装" class="sidebar-link reco-side-三、-elasticsearch安装" data-v-b57cc07c>三、 ElasticSearch安装</a></li><li class="level-3" data-v-b57cc07c><a href="/java/part4/elasticsearch.html#四、-elasticsearch基本操作" class="sidebar-link reco-side-四、-elasticsearch基本操作" data-v-b57cc07c>四、 ElasticSearch基本操作</a></li><li class="level-3" data-v-b57cc07c><a href="/java/part4/elasticsearch.html#五、java操作elasticsearch【重点】" class="sidebar-link reco-side-五、java操作elasticsearch【重点】" data-v-b57cc07c>五、Java操作ElasticSearch【重点】</a></li><li class="level-3" data-v-b57cc07c><a href="/java/part4/elasticsearch.html#六、-elasticsearch的各种查询" class="sidebar-link reco-side-六、-elasticsearch的各种查询" data-v-b57cc07c>六、 ElasticSearch的各种查询</a></li><li class="level-3" data-v-b57cc07c><a href="/java/part4/elasticsearch.html#七、-个人学习" class="sidebar-link reco-side-七、-个人学习" data-v-b57cc07c>七、 个人学习</a></li><li class="level-3" data-v-b57cc07c><a href="/java/part4/elasticsearch.html#八、elasticsearch-环境" class="sidebar-link reco-side-八、elasticsearch-环境" data-v-b57cc07c>八、Elasticsearch 环境</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----></div></div>
    <script src="/assets/js/app.cf24e5c2.js" defer></script><script src="/assets/js/3.96e6e8dc.js" defer></script><script src="/assets/js/1.9cd0fbb8.js" defer></script><script src="/assets/js/35.fc2b775b.js" defer></script>
  </body>
</html>
